/**
 * @license MelonJS Game Engine
 * @copyright (C) 2011 - 2013 Olivier Biot, Jason Oster
 * http://www.melonjs.org
 *
 * melonJS is licensed under the MIT License.
 * http://www.opensource.org/licenses/mit-license.php
 *
 */
window.me=window.me||{};(function($){var document=$.document;me={mod:"melonJS",version:"0.9.8",nocache:"",audio:null,video:null,timer:null,input:null,state:null,game:null,entityPool:null,levelDirector:null,TMXParser:null,loadingScreen:null,TMXTileMap:null};me.sys={ua:navigator.userAgent,sound:false,localStorage:(typeof($.localStorage)==="object"),gyro:($.DeviceMotionEvent!==undefined),nativeBase64:(typeof($.atob)==="function"),touch:false,isMobile:false,fps:60,interpolation:false,scale:null,scalingInterpolation:false,gravity:undefined,cacheImage:false,dirtyRegion:false,stopOnAudioError:true,pauseOnBlur:true,preRender:false,checkVersion:function(first,second){second=second||me.version;var a=first.split(".");var b=second.split(".");var len=Math.min(a.length,b.length);var result=0;for(var i=0;i<len;i++){if(result=+a[i]-+b[i]){break}}return result?result:a.length-b.length}};var me_initialized=false;var readyBound=false,isReady=false,readyList=[];function domReady(){if(!isReady){if(!document.body){return setTimeout(domReady,13)}if(document.removeEventListener){document.removeEventListener("DOMContentLoaded",domReady,false)}else{$.removeEventListener("load",domReady,false)}isReady=true;for(var fn=0;fn<readyList.length;fn++){readyList[fn].call($,[])}readyList.length=0}}function bindReady(){if(readyBound){return}readyBound=true;if(document.readyState==="complete"){return domReady()}else{if(document.addEventListener){document.addEventListener("DOMContentLoaded",domReady,false)}$.addEventListener("load",domReady,false)}}$.onReady=function(fn){bindReady();if(isReady){fn.call($,[])}else{readyList.push(function(){return fn.call($,[])})}return this};$.onReady(function(){_init_ME()});var initializing=false,fnTest=/var xyz/.test(function(){var xyz})?/\bparent\b/:/[\D|\d]*/;Object.extend=function(prop){var parent=this.prototype;initializing=true;var proto=new this();initializing=false;for(var name in prop){proto[name]=typeof prop[name]==="function"&&typeof parent[name]==="function"&&fnTest.test(prop[name])?(function(name,fn){return function(){var tmp=this.parent;this.parent=parent[name];var ret=fn.apply(this,arguments);this.parent=tmp;return ret}})(name,prop[name]):prop[name]}function Class(){if(!initializing&&this.init){this.init.apply(this,arguments)}}Class.prototype=proto;Class.constructor=Class;Class.extend=Object.extend;return Class};if(typeof Object.create!=="function"){Object.create=function(o){function _fn(){}_fn.prototype=o;return new _fn()}}if(!Function.prototype.bind){function Empty(){}Function.prototype.bind=function bind(that){var target=this;if(typeof target!=="function"){throw new TypeError("Function.prototype.bind called on incompatible "+target)}var args=Array.prototype.slice.call(arguments,1);var bound=function(){if(this instanceof bound){var result=target.apply(this,args.concat(Array.prototype.slice.call(arguments)));if(Object(result)===result){return result}return this}else{return target.apply(that,args.concat(Array.prototype.slice.call(arguments)))}};if(target.prototype){Empty.prototype=target.prototype;bound.prototype=new Empty();Empty.prototype=null}return bound}}if(!window.throttle){window.throttle=function(delay,no_trailing,callback,debounce_mode){var last=Date.now(),deferTimer;if(typeof no_trailing!=="boolean"){no_trailing=false}return function(){var now=Date.now();var elasped=now-last;var args=arguments;if(elasped<delay){if(no_trailing===false){clearTimeout(deferTimer);deferTimer=setTimeout(function(){last=now;return callback.apply(null,args)},elasped)}}else{last=now;return callback.apply(null,args)}}}}if(typeof Date.now==="undefined"){Date.now=function(){return new Date().getTime()}}if(typeof console==="undefined"){console={log:function(){},info:function(){},error:function(){alert(Array.prototype.slice.call(arguments).join(", "))}}}Function.prototype.defer=function(){var fn=this,args=Array.prototype.slice.call(arguments);return window.setTimeout(function(){return fn.apply(fn,args)},0.01)};if(!Object.defineProperty){Object.defineProperty=function(obj,prop,desc){if(obj.__defineGetter__){if(desc.get){obj.__defineGetter__(prop,desc.get)}if(desc.set){obj.__defineSetter__(prop,desc.set)}}else{throw"melonJS: Object.defineProperty not supported"}}}if(!String.prototype.trim){String.prototype.trim=function(){return(this.replace(/^\s+/,"")).replace(/\s+$/,"")}}String.prototype.isNumeric=function(){return(this!==null&&!isNaN(this)&&this.trim()!=="")};String.prototype.isBoolean=function(){return(this!==null&&("true"===this.trim()||"false"===this.trim()))};String.prototype.contains=function(word){return this.indexOf(word)>-1};String.prototype.toHex=function(){var res="",c=0;while(c<this.length){res+=this.charCodeAt(c++).toString(16)}return res};Number.prototype.clamp=function(low,high){return this<low?low:this>high?high:+this};Number.prototype.random=function(min,max){return(~~(Math.random()*(max-min+1))+min)};Number.prototype.round=function(){var num=(arguments.length<2)?this:arguments[0];var powres=Math.pow(10,arguments[1]||arguments[0]||0);return(Math.round(num*powres)/powres)};Number.prototype.toHex=function(){return"0123456789ABCDEF".charAt((this-this%16)>>4)+"0123456789ABCDEF".charAt(this%16)};Number.prototype.sign=function(){return this<0?-1:(this>0?1:0)};Number.prototype.degToRad=function(angle){return(angle||this)/180*Math.PI};Number.prototype.radToDeg=function(angle){return(angle||this)*(180/Math.PI)};Array.prototype.remove=function(obj){var i=Array.prototype.indexOf.call(this,obj);if(i!==-1){Array.prototype.splice.call(this,i,1)}return this};if(!Array.prototype.forEach){Array.prototype.forEach=function(callback,scope){for(var i=0,j=this.length;j--;i++){callback.call(scope||this,this[i],i,this)}}}Object.defineProperty(me,"initialized",{get:function get(){return me_initialized}});function _init_ME(){if(me_initialized){return}me.utils.setNocache(document.location.href.match(/\?nocache/)||false);me.audio.detectCapabilities();navigator.pointerEnabled=navigator.pointerEnabled||navigator.msPointerEnabled;navigator.maxTouchPoints=navigator.maxTouchPoints||navigator.msMaxTouchPoints||0;window.gesture=window.gesture||window.MSGesture;me.sys.touch=("createTouch" in document)||("ontouchstart" in $)||(navigator.isCocoonJS)||(navigator.maxTouchPoints>0);me.sys.isMobile=me.sys.ua.match(/Android|iPhone|iPad|iPod|BlackBerry|Windows Phone|Mobile/i);me.timer.init();me.mapReader=new me.TMXMapReader();me.loadingScreen=new me.DefaultLoadingScreen();me.state.init();me.entityPool.init();me.levelDirector.reset();me_initialized=true}var drawManager=(function(){var api={};var dirtyRects=[];var fullscreen_rect;var dirtyObjects=[];var drawCount=0;api.isDirty=false;api.reset=function(){dirtyRects.length=0;dirtyObjects.length=0;fullscreen_rect=me.game.viewport.getRect();api.makeAllDirty()};api.makeDirty=function(obj,updated,oldRect){if(updated){api.isDirty=true;if(me.sys.dirtyRegion){if(oldRect){dirtyRects.push(oldRect.union(obj))}else{if(obj.getRect){dirtyRects.push(obj.getRect())}}}}if(obj.inViewport){dirtyObjects.unshift(obj)}};api.makeAllDirty=function(){dirtyRects.length=0;dirtyRects.push(fullscreen_rect);api.isDirty=true};api.remove=function(obj){var idx=dirtyObjects.indexOf(obj);if(idx!==-1){dirtyObjects.splice(idx,1);obj.inViewport=false;api.makeDirty(obj,true)}};api.getDrawCount=function(){return drawCount};api.draw=function(context){var posx=me.game.viewport.pos.x+~~me.game.viewport.offset.x;var posy=me.game.viewport.pos.y+~~me.game.viewport.offset.y;context.save();context.translate(-posx,-posy);posx-=me.game.currentLevel.pos.x;posy-=me.game.currentLevel.pos.y;for(var r=dirtyRects.length,rect;r--,rect=dirtyRects[r];){for(var o=dirtyObjects.length,obj;o--,obj=dirtyObjects[o];){if(me.sys.dirtyRegion&&obj.isSprite&&!obj.overlaps(rect)){continue}if(obj.floating===true){context.save();context.translate(posx,posy)}obj.draw(context,rect);if(obj.floating===true){context.restore()}drawCount++}if(me.debug.renderDirty){rect.draw(context,"white")}}context.restore()};api.flush=function(){if(me.sys.dirtyRegion){dirtyRects.length=0}dirtyObjects.length=0;api.isDirty=false;drawCount=0};return api})();me.game=(function(){var api={};var frameBuffer=null;var gameObjects=[];var initialized=false;var pendingRemove=null;var pendingSort=null;var default_sort_func=function(a,b){return(b.z-a.z)};api.viewport=null;api.HUD=null;api.collisionMap=null;api.currentLevel=null;api.renderer=null;api.NO_OBJECT=0;api.ENEMY_OBJECT=1;api.COLLECTABLE_OBJECT=2;api.ACTION_OBJECT=3;api.onLevelLoaded=null;api.init=function(width,height){if(!initialized){var width=width||me.video.getWidth();var height=height||me.video.getHeight();api.viewport=new me.Viewport(0,0,width,height);frameBuffer=me.video.getSystemContext();me.event.publish(me.event.GAME_INIT);initialized=true}};api.reset=function(){if(!initialized){api.init()}api.removeAll(true);if(api.viewport){api.viewport.reset()}drawManager.reset();frameBuffer.setTransform(1,0,0,1,0,0);api.currentLevel={pos:{x:0,y:0}}};api.loadTMXLevel=function(level){api.currentLevel=level;api.collisionMap=api.currentLevel.getLayerByName("collision");if(!api.collisionMap||!api.collisionMap.isCollisionMap){console.error("WARNING : no collision map detected")}var layers=api.currentLevel.getLayers();for(var i=layers.length;i--;){if(layers[i].visible){api.add(layers[i])}}api.viewport.setBounds(Math.max(api.currentLevel.width,api.viewport.width),Math.max(api.currentLevel.height,api.viewport.height));var objectGroups=api.currentLevel.getObjectGroups();for(var group=0;group<objectGroups.length;group++){if(objectGroups[group].visible){for(var entity=0;entity<objectGroups[group].objects.length;entity++){api.addEntity(objectGroups[group].objects[entity],objectGroups[group].z)}}}if(api.currentLevel.pos.x!==api.currentLevel.pos.y){frameBuffer.translate(api.currentLevel.pos.x,api.currentLevel.pos.y)}api.sort();if(api.onLevelLoaded){api.onLevelLoaded.call(api.onLevelLoaded,level.name)}me.event.publish(me.event.LEVEL_LOADED,[level.name])};api.add=function(object,zOrder){object.z=(zOrder)?zOrder:object.z;gameObjects.push(object)};api.addEntity=function(ent,zOrder){var obj=me.entityPool.newInstanceOf(ent.name,ent.x,ent.y,ent);if(obj){api.add(obj,zOrder)}};api.getEntityByName=function(entityName){var objList=[];entityName=entityName.toLowerCase();for(var i=gameObjects.length,obj;i--,obj=gameObjects[i];){if(obj.name&&obj.name.toLowerCase()===entityName){objList.push(obj)}}return objList};api.getObjectCount=function(){return gameObjects.length};api.getDrawCount=function(){return drawManager.getDrawCount()};api.getEntityByGUID=function(guid){for(var i=gameObjects.length,obj;i--,obj=gameObjects[i];){if(obj.isEntity&&obj.GUID==guid){return obj}}return null};api.getEntityByProp=function(prop,value){var objList=[];for(var i=gameObjects.length,obj;i--,obj=gameObjects[i];){if(obj.isEntity&&obj[prop]==value){objList.push(obj)}}return objList};api.addHUD=function(x,y,w,h,bg){if(api.HUD==null){api.HUD=new me.HUD_Object(x,y,w,h,bg);api.add(api.HUD)}};api.disableHUD=function(){if(api.HUD!=null){api.remove(api.HUD);api.HUD=null}};api.update=function(){var oldRect=null;for(var i=gameObjects.length,obj;i--,obj=gameObjects[i];){oldRect=(me.sys.dirtyRegion&&obj.isSprite)?obj.getRect():null;obj.inViewport=obj.visible&&(obj.floating||(obj.getRect&&api.viewport.isVisible(obj)));var updated=(obj.inViewport||obj.alwaysUpdate)&&obj.update();drawManager.makeDirty(obj,updated,updated?oldRect:null)}if(api.viewport.update(drawManager.isDirty)){drawManager.makeAllDirty()}};api.remove=function(obj,force){function removeNow(target){if(target.destroy){target.destroy()}drawManager.remove(target);gameObjects.remove(target);me.entityPool.freeInstance(target)}if(gameObjects.indexOf(obj)>-1){if(force===true){removeNow(obj)}else{obj.visible=false;pendingRemove=(function(obj){removeNow(obj);pendingRemove=null}).defer(obj)}}};api.removeAll=function(force){if(pendingRemove){clearTimeout(pendingRemove);pendingRemove=null}if(pendingSort){clearTimeout(pendingSort);pendingSort=null}for(var i=gameObjects.length;i--;){if(gameObjects[i].isPersistent){continue}api.remove(gameObjects[i],force)}if(force===true){drawManager.flush()}};api.sort=function(sort_func){if(pendingSort===null){if(typeof(sort_func)!=="function"){sort_func=default_sort_func}pendingSort=(function(sort_func){gameObjects.sort(sort_func);pendingSort=null;me.game.repaint()}).defer(sort_func)}};api.collide=function(objA,multiple){var res;multiple=multiple===true?true:false;if(multiple===true){var mres=[],r=0}for(var i=gameObjects.length,obj;i--,obj=gameObjects[i];){if((obj.inViewport||obj.alwaysUpdate)&&obj.collidable&&(obj!=objA)){res=obj.collisionBox.collideVsAABB.call(obj.collisionBox,objA.collisionBox);if(res.x!=0||res.y!=0){obj.onCollision.call(obj,res,objA);res.type=obj.type;res.obj=obj;if(!multiple){return res}mres[r++]=res}}}return multiple?mres:null};api.collideType=function(objA,type,multiple){var res;multiple=multiple===true?true:false;if(multiple===true){var mres=[],r=0}for(var i=gameObjects.length,obj;i--,obj=gameObjects[i];){if((obj.inViewport||obj.alwaysUpdate)&&obj.collidable&&(obj.type===type)&&(obj!=objA)){res=obj.collisionBox.collideVsAABB.call(obj.collisionBox,objA.collisionBox);if(res.x!=0||res.y!=0){obj.onCollision.call(obj,res,objA);res.type=obj.type;res.obj=obj;if(!multiple){return res}mres[r++]=res}}}return multiple?mres:null};api.repaint=function(){drawManager.makeAllDirty()};api.draw=function(){if(drawManager.isDirty){drawManager.draw(frameBuffer);api.viewport.draw(frameBuffer)}drawManager.flush()};return api})()})(window);(function($){me.Vector2d=Object.extend({x:0,y:0,init:function(x,y){this.x=x||0;this.y=y||0},set:function(x,y){this.x=x;this.y=y;return this},setZero:function(){return this.set(0,0)},setV:function(v){this.x=v.x;this.y=v.y;return this},add:function(v){this.x+=v.x;this.y+=v.y;return this},sub:function(v){this.x-=v.x;this.y-=v.y;return this},scale:function(v){this.x*=v.x;this.y*=v.y;return this},div:function(n){this.x/=n;this.y/=n;return this},abs:function(){if(this.x<0){this.x=-this.x}if(this.y<0){this.y=-this.y}return this},clamp:function(low,high){return new me.Vector2d(this.x.clamp(low,high),this.y.clamp(low,high))},clampSelf:function(low,high){this.x=this.x.clamp(low,high);this.y=this.y.clamp(low,high);return this},minV:function(v){this.x=this.x<v.x?this.x:v.x;this.y=this.y<v.y?this.y:v.y;return this},maxV:function(v){this.x=this.x>v.x?this.x:v.x;this.y=this.y>v.y?this.y:v.y;return this},floor:function(){return new me.Vector2d(~~this.x,~~this.y)},floorSelf:function(){this.x=~~this.x;this.y=~~this.y;return this},ceil:function(){return new me.Vector2d(Math.ceil(this.x),Math.ceil(this.y))},ceilSelf:function(){this.x=Math.ceil(this.x);this.y=Math.ceil(this.y);return this},negate:function(){return new me.Vector2d(-this.x,-this.y)},negateSelf:function(){this.x=-this.x;this.y=-this.y;return this},copy:function(v){this.x=v.x;this.y=v.y;return this},equals:function(v){return((this.x===v.x)&&(this.y===v.y))},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},normalize:function(){var len=this.length();if(len<Number.MIN_VALUE){return 0}var invL=1/len;this.x*=invL;this.y*=invL;return len},dotProduct:function(v){return this.x*v.x+this.y*v.y},distance:function(v){return Math.sqrt((this.x-v.x)*(this.x-v.x)+(this.y-v.y)*(this.y-v.y))},angle:function(v){return Math.atan2((v.y-this.y),(v.x-this.x))},clone:function(){return new me.Vector2d(this.x,this.y)},toString:function(){return"x:"+this.x+",y:"+this.y}});me.Rect=Object.extend({pos:null,colPos:null,anchorPoint:null,width:0,height:0,hWidth:0,hHeight:0,init:function(v,w,h){this.pos=v;this.colPos=new me.Vector2d();this.width=w;this.height=h;this.hWidth=~~(w/2);this.hHeight=~~(h/2);this.anchorPoint=new me.Vector2d(0.5,0.5);Object.defineProperty(this,"left",{get:function(){return this.pos.x},configurable:true});Object.defineProperty(this,"right",{get:function(){return this.pos.x+this.width},configurable:true});Object.defineProperty(this,"top",{get:function(){return this.pos.y},configurable:true});Object.defineProperty(this,"bottom",{get:function(){return this.pos.y+this.height},configurable:true})},set:function(v,w,h){this.pos=v;this.width=w;this.height=h;this.hWidth=~~(w/2);this.hHeight=~~(h/2)},getRect:function(){return new me.Rect(this.pos.clone(),this.width,this.height)},translate:function(x,y){this.pos.x+=x;this.pos.y+=y;return this},translateV:function(v){this.pos.add(v);return this},union:function(r){var x1=Math.min(this.pos.x,r.pos.x);var y1=Math.min(this.pos.y,r.pos.y);this.width=Math.ceil(Math.max(this.pos.x+this.width,r.pos.x+r.width)-x1);this.height=Math.ceil(Math.max(this.pos.y+this.height,r.pos.y+r.height)-y1);this.pos.x=~~x1;this.pos.y=~~y1;return this},adjustSize:function(x,w,y,h){if(x!=-1){this.colPos.x=x;this.width=w;this.hWidth=~~(this.width/2);if(this.left!==this.pos.x+this.colPos.x){Object.defineProperty(this,"left",{get:function(){return this.pos.x+this.colPos.x},configurable:true})}if(this.right!==this.pos.x+this.colPos.x+this.width){Object.defineProperty(this,"right",{get:function(){return this.pos.x+this.colPos.x+this.width},configurable:true})}}if(y!=-1){this.colPos.y=y;this.height=h;this.hHeight=~~(this.height/2);if(this.top!==this.pos.y+this.colPos.y){Object.defineProperty(this,"top",{get:function(){return this.pos.y+this.colPos.y},configurable:true})}if(this.bottom!==this.pos.y+this.colPos.y+this.height){Object.defineProperty(this,"bottom",{get:function(){return this.pos.y+this.colPos.y+this.height},configurable:true})}}},flipX:function(sw){this.colPos.x=sw-this.width-this.colPos.x;this.hWidth=~~(this.width/2)},flipY:function(sh){this.colPos.y=sh-this.height-this.colPos.y;this.hHeight=~~(this.height/2)},equals:function(r){return(this.left===r.left&&this.right===r.right&&this.top===r.top&&this.bottom===r.bottom)},overlaps:function(r){return(this.left<r.right&&r.left<this.right&&this.top<r.bottom&&r.top<this.bottom)},within:function(r){return(r.left<=this.left&&r.right>=this.right&&r.top<=this.top&&r.bottom>=this.bottom)},contains:function(r){return(r.left>=this.left&&r.right<=this.right&&r.top>=this.top&&r.bottom<=this.bottom)},containsPointV:function(v){return this.containsPoint(v.x,v.y)},containsPoint:function(x,y){return(x>=this.left&&x<=this.right&&(y>=this.top)&&y<=this.bottom)},collideVsAABB:function(rect){var p=new me.Vector2d(0,0);if(this.overlaps(rect)){var dx=this.left+this.hWidth-rect.left-rect.hWidth;var dy=this.top+this.hHeight-rect.top-rect.hHeight;p.x=(rect.hWidth+this.hWidth)-(dx<0?-dx:dx);p.y=(rect.hHeight+this.hHeight)-(dy<0?-dy:dy);if(p.x<p.y){p.y=0;p.x=dx<0?-p.x:p.x}else{p.x=0;p.y=dy<0?-p.y:p.y}}return p},draw:function(context,color){context.strokeStyle=color||"red";context.strokeRect(this.left,this.top,this.width,this.height)}})})(window);(function($){me.debug={displayFPS:false,renderHitBox:false,renderCollisionMap:false,renderDirty:false,renderVelocity:false}})(window);(function($){me.Renderable=me.Rect.extend({isRenderable:true,visible:true,inViewport:false,alwaysUpdate:false,isPersistent:false,floating:false,z:0,init:function(pos,width,height){this.parent(pos,width,height)},update:function(){return false},draw:function(context,color){this.parent(context,color)}})})(window);(function($){me.SpriteObject=me.Renderable.extend({scale:null,scaleFlag:false,lastflipX:false,lastflipY:false,z:0,offset:null,angle:0,_sourceAngle:0,alpha:1,image:null,flickering:false,flickerTimer:-1,flickercb:null,flickerState:false,init:function(x,y,image,spritewidth,spriteheight){this.isSprite=true;this.parent(new me.Vector2d(x,y),spritewidth||image.width,spriteheight||image.height);this.image=image;this.scale=new me.Vector2d(1,1);this.lastflipX=this.lastflipY=false;this.scaleFlag=false;this.offset=new me.Vector2d(0,0);this.alpha=1;this.visible=true;this.isPersistent=false;this.flickering=false},setTransparency:function(col){col=(col.charAt(0)=="#")?col.substring(1,7):col;this.image=me.video.applyRGBFilter(this.image,"transparent",col.toUpperCase()).canvas},isFlickering:function(){return this.flickering},flicker:function(duration,callback){this.flickerTimer=duration;if(this.flickerTimer<0){this.flickering=false;this.flickercb=null}else{if(!this.flickering){this.flickercb=callback;this.flickering=true}}},flipX:function(flip){if(flip!=this.lastflipX){this.lastflipX=flip;this.scale.x=-this.scale.x;this.scaleFlag=((this.scale.x!=1)||(this.scale.y!=1))}},flipY:function(flip){if(flip!=this.lastflipY){this.lastflipY=flip;this.scale.y=-this.scale.y;this.scaleFlag=((this.scale.x!=1)||(this.scale.y!=1))}},resize:function(ratio){if(ratio>0){this.scale.x=this.scale.x<0?-ratio:ratio;this.scale.y=this.scale.y<0?-ratio:ratio;this.scaleFlag=((this.scale.x!=1)||(this.scale.y!=1))}},getOpacity:function(){return this.alpha},setOpacity:function(alpha){if(typeof(alpha)==="number"){this.alpha=alpha.clamp(0,1)}},update:function(){if(this.flickering){this.flickerTimer-=me.timer.tick;if(this.flickerTimer<0){if(this.flickercb){this.flickercb()}this.flicker(-1)}return true}return false},draw:function(context){if(this.flickering){this.flickerState=!this.flickerState;if(!this.flickerState){return}}context.save();context.globalAlpha=this.alpha;var xpos=~~this.pos.x,ypos=~~this.pos.y;var w=this.width,h=this.height;var angle=this.angle+this._sourceAngle;if((this.scaleFlag)||(angle!==0)){var ax=w*this.anchorPoint.x,ay=h*this.anchorPoint.y;context.translate(xpos+ax,ypos+ay);if(this.scaleFlag){context.scale(this.scale.x,this.scale.y)}if(angle!==0){context.rotate(angle)}if(this._sourceAngle!==0){w=this.height,h=this.width;xpos=-ay,ypos=-ax}else{xpos=-ax,ypos=-ay}}context.drawImage(this.image,this.offset.x,this.offset.y,w,h,xpos,ypos,w,h);context.restore();if(me.debug.renderHitBox){this.parent(context,"green")}},destroy:function(){this.onDestroyEvent.apply(this,arguments)},onDestroyEvent:function(){}});me.AnimationSheet=me.SpriteObject.extend({fpscount:0,spacing:0,margin:0,animationpause:false,animationspeed:0,init:function(x,y,image,spritewidth,spriteheight,spacing,margin,atlas,atlasIndices){this.anim=[];this.resetAnim=null;this.current=null;this.animationspeed=me.sys.fps/10;this.spacing=spacing||0;this.margin=margin||0;this.parent(x,y,image,spritewidth,spriteheight,spacing,margin);this.textureAtlas=null;this.atlasIndices=null;this.buildLocalAtlas(atlas||undefined,atlasIndices||undefined);this.addAnimation("default",null);this.setCurrentAnimation("default")},buildLocalAtlas:function(atlas,indices){if(atlas!==undefined){this.textureAtlas=atlas;this.atlasIndices=indices}else{this.textureAtlas=[];var spritecount=new me.Vector2d(~~((this.image.width-this.margin)/(this.width+this.spacing)),~~((this.image.height-this.margin)/(this.height+this.spacing)));for(var frame=0,count=spritecount.x*spritecount.y;frame<count;frame++){this.textureAtlas[frame]={name:""+frame,offset:new me.Vector2d(this.margin+(this.spacing+this.width)*(frame%spritecount.x),this.margin+(this.spacing+this.height)*~~(frame/spritecount.x)),width:this.width,height:this.height,angle:0}}}},addAnimation:function(name,index,animationspeed){this.anim[name]={name:name,frame:[],idx:0,length:0,animationspeed:animationspeed||this.animationspeed};if(index==null){index=[];var i=0;this.textureAtlas.forEach(function(){index[i]=i++})}for(var i=0,len=index.length;i<len;i++){if(typeof(index[i])==="number"){this.anim[name].frame[i]=this.textureAtlas[index[i]]}else{if(this.atlasIndices===null){throw"melonjs: string parameters for addAnimation are only allowed for TextureAtlas "}else{this.anim[name].frame[i]=this.textureAtlas[this.atlasIndices[index[i]]]}}}this.anim[name].length=this.anim[name].frame.length},setCurrentAnimation:function(name,resetAnim){if(this.anim[name]){this.current=this.anim[name];this.resetAnim=resetAnim||null;this.setAnimationFrame(this.current.idx)}else{throw"melonJS: animation id '"+name+"' not defined"}},isCurrentAnimation:function(name){return(this.current.name==name)},setAnimationFrame:function(idx){this.current.idx=(idx||0)%this.current.length;var frame=this.current.frame[this.current.idx];this.offset=frame.offset;this.width=frame.width;this.height=frame.height;this._sourceAngle=frame.angle},getCurrentAnimationFrame:function(){return this.current.idx},update:function(){if(!this.animationpause&&(this.fpscount++>this.current.animationspeed)){this.setAnimationFrame(++this.current.idx);this.fpscount=0;if((this.current.idx==0)&&this.resetAnim){if(typeof(this.resetAnim)=="string"){this.setCurrentAnimation(this.resetAnim)}else{if(typeof(this.resetAnim)=="function"&&this.resetAnim()===false){this.current.idx=this.current.length-1;this.setAnimationFrame(this.current.idx);this.parent();return false}}}return this.parent()||true}return this.parent()}})})(window);(function($){var nhPI=-(Math.PI/2);me.TextureAtlas=Object.extend({format:null,texture:null,atlas:null,init:function(atlas,texture){if(atlas&&atlas.meta){if(atlas.meta.app.contains("texturepacker")){this.format="texturepacker";if(texture===undefined){var name=me.utils.getBasename(atlas.meta.image);this.texture=me.loader.getImage(name);if(this.texture===null){throw"melonjs: Atlas texture '"+name+"' not found"}}else{this.texture=texture}}if(atlas.meta.app.contains("ShoeBox")){if(!atlas.meta.exporter||!atlas.meta.exporter.contains("melonJS")){throw"melonjs: ShoeBox requires the JSON exporter : https://github.com/melonjs/melonJS/tree/master/media/shoebox_JSON_export.sbx"}this.format="ShoeBox";this.texture=texture}this.atlas=this.initFromTexturePacker(atlas)}if(this.atlas===null){throw"melonjs: texture atlas format not supported"}},initFromTexturePacker:function(data){var atlas={};data.frames.forEach(function(frame){if(frame.hasOwnProperty("filename")){atlas[frame.filename]={frame:new me.Rect(new me.Vector2d(frame.frame.x,frame.frame.y),frame.frame.w,frame.frame.h),source:new me.Rect(new me.Vector2d(frame.spriteSourceSize.x,frame.spriteSourceSize.y),frame.spriteSourceSize.w,frame.spriteSourceSize.h),rotated:frame.rotated===true,trimmed:frame.trimmed===true}}});return atlas},getTexture:function(){return this.texture},getRegion:function(name){var region=this.atlas[name];if(region){return{name:name,pos:region.source.pos.clone(),offset:region.frame.pos.clone(),width:region.frame.width,height:region.frame.height,angle:(region.rotated===true)?nhPI:0}}return null},createSpriteFromName:function(name){var region=this.getRegion(name);if(region){var sprite=new me.SpriteObject(0,0,this.getTexture(),region.width,region.height);sprite.offset.setV(region.offset);sprite._sourceAngle=region.angle;return sprite}throw"melonjs: TextureAtlas - region for "+name+" not found"},createAnimationFromName:function(names){var tpAtlas=[],indices={};for(var i=0;i<names.length;++i){tpAtlas[i]=this.getRegion(names[i]);indices[names[i]]=i;if(tpAtlas[i]==null){throw"melonjs: TextureAtlas - region for "+names[i]+" not found"}}return new me.AnimationSheet(0,0,this.texture,0,0,0,0,tpAtlas,indices)}})})(window);(function($){var MIN=Math.min,MAX=Math.max;me.Viewport=me.Rect.extend({AXIS:{NONE:0,HORIZONTAL:1,VERTICAL:2,BOTH:3},limits:null,target:null,follow_axis:0,shaking:false,_shake:null,_fadeIn:null,_fadeOut:null,_deadwidth:0,_deadheight:0,_limitwidth:0,_limitheight:0,init:function(minX,minY,maxX,maxY,realw,realh){this.parent(new me.Vector2d(minX,minY),maxX-minX,maxY-minY);this.limits=new me.Vector2d(realw||this.width,realh||this.height);this.offset=new me.Vector2d();this.target=null;this.follow_axis=this.AXIS.NONE;this._shake={intensity:0,duration:0,axis:this.AXIS.BOTH,onComplete:null,start:0};this._fadeOut={color:0,alpha:0,duration:0,tween:null};this._fadeIn={color:0,alpha:1,duration:0,tween:null};this.setDeadzone(this.width/6,this.height/6)},_followH:function(target){if((target.x-this.pos.x)>(this._deadwidth)){this.pos.x=~~MIN((target.x)-(this._deadwidth),this._limitwidth);return true}else{if((target.x-this.pos.x)<(this.deadzone.x)){this.pos.x=~~MAX((target.x)-this.deadzone.x,0);return true}}return false},_followV:function(target){if((target.y-this.pos.y)>(this._deadheight)){this.pos.y=~~MIN((target.y)-(this._deadheight),this._limitheight);return true}else{if((target.y-this.pos.y)<(this.deadzone.y)){this.pos.y=~~MAX((target.y)-this.deadzone.y,0);return true}}return false},reset:function(x,y){this.pos.x=x||0;this.pos.y=y||0;this.target=null;this.follow_axis=null},setDeadzone:function(w,h){this.deadzone=new me.Vector2d(~~((this.width-w)/2),~~((this.height-h)/2-h*0.25));this._deadwidth=this.width-this.deadzone.x;this._deadheight=this.height-this.deadzone.y;this.update(true)},setBounds:function(w,h){this.limits.set(w,h);this._limitwidth=this.limits.x-this.width;this._limitheight=this.limits.y-this.height},follow:function(target,axis){if(target instanceof me.ObjectEntity){this.target=target.pos}else{if(target instanceof me.Vector2d){this.target=target}else{throw"melonJS: invalid target for viewport.follow"}}this.follow_axis=axis||this.AXIS.BOTH;this.update(true)},move:function(x,y){var newx=~~(this.pos.x+x);var newy=~~(this.pos.y+y);this.pos.x=newx.clamp(0,this._limitwidth);this.pos.y=newy.clamp(0,this._limitheight)},update:function(updateTarget){if(this.target&&updateTarget){switch(this.follow_axis){case this.AXIS.NONE:break;case this.AXIS.HORIZONTAL:updateTarget=this._followH(this.target);break;case this.AXIS.VERTICAL:updateTarget=this._followV(this.target);break;case this.AXIS.BOTH:updateTarget=this._followH(this.target);updateTarget=this._followV(this.target)||updateTarget;break;default:break}}if(this.shaking){var delta=me.timer.getTime()-this._shake.start;if(delta>=this._shake.duration){this.shaking=false;this.offset.setZero();if(typeof(this._shake.onComplete)==="function"){this._shake.onComplete()}}else{if(this._shake.axis==this.AXIS.BOTH||this._shake.axis==this.AXIS.HORIZONTAL){this.offset.x=(Math.random()-0.5)*this._shake.intensity}if(this._shake.axis==this.AXIS.BOTH||this._shake.axis==this.AXIS.VERTICAL){this.offset.y=(Math.random()-0.5)*this._shake.intensity}}updateTarget=true}if((this._fadeIn.tween!=null)||(this._fadeOut.tween!=null)){updateTarget=true}return updateTarget},shake:function(intensity,duration,axis,onComplete){if(this.shaking){return}this.shaking=true;this._shake={intensity:intensity,duration:duration,axis:axis||this.AXIS.BOTH,onComplete:onComplete||null,start:me.timer.getTime()}},fadeOut:function(color,duration,onComplete){this._fadeOut.color=color;this._fadeOut.duration=duration||1000;this._fadeOut.alpha=1;this._fadeOut.tween=new me.Tween(this._fadeOut).to({alpha:0},this._fadeOut.duration).onComplete(onComplete||null);this._fadeOut.tween.start()},fadeIn:function(color,duration,onComplete){this._fadeIn.color=color;this._fadeIn.duration=duration||1000;this._fadeIn.alpha=0;this._fadeIn.tween=new me.Tween(this._fadeIn).to({alpha:1},this._fadeIn.duration).onComplete(onComplete||null);this._fadeIn.tween.start()},getWidth:function(){return this.width},getHeight:function(){return this.height},focusOn:function(target){this.pos.x=target.x-this.width*0.5;this.pos.y=target.y-this.height*0.5},isVisible:function(rect){return rect.overlaps(this)},screenToWorld:function(x,y){return(new me.Vector2d(x,y)).add(this.pos).sub(me.game.currentLevel.pos)},worldToScreen:function(x,y){return(new me.Vector2d(x,y)).add(this.pos).add(me.game.currentLevel.pos)},draw:function(context){if(this._fadeIn.tween){context.globalAlpha=this._fadeIn.alpha;me.video.clearSurface(context,me.utils.HexToRGB(this._fadeIn.color));context.globalAlpha=1;if(this._fadeIn.alpha==1){this._fadeIn.tween=null}}if(this._fadeOut.tween){context.globalAlpha=this._fadeOut.alpha;me.video.clearSurface(context,me.utils.HexToRGB(this._fadeOut.color));context.globalAlpha=1;if(this._fadeOut.alpha==0){this._fadeOut.tween=null}}}})})(window);(function($){me.ObjectSettings={name:null,image:null,transparent_color:null,spritewidth:null,spriteheight:null,type:0,collidable:true};me.entityPool=(function(){var obj={};var entityClass={};obj.init=function(){obj.add("me.ObjectEntity",me.ObjectEntity);obj.add("me.CollectableEntity",me.CollectableEntity);obj.add("me.LevelEntity",me.LevelEntity)};obj.add=function(className,entityObj,pooling){if(!pooling){entityClass[className.toLowerCase()]=entityObj;return}entityClass[className.toLowerCase()]={"class":entityObj,pool:[],active:[]}};obj.newInstanceOf=function(data){var name=typeof data==="string"?data.toLowerCase():undefined;if(name&&entityClass[name]){if(!entityClass[name]["pool"]){var proto=entityClass[name];arguments[0]=proto;return new (proto.bind.apply(proto,arguments))()}var obj,entity=entityClass[name],proto=entity["class"];if(entity.pool.length>0){obj=entity.pool.pop();obj.init.apply(obj,Array.prototype.slice.call(arguments,1))}else{arguments[0]=proto;obj=new (proto.bind.apply(proto,arguments))();obj.className=name}entity.active.push(obj);return obj}var settings=arguments[3];if(settings&&settings.image){return new me.SpriteObject(settings.x,settings.y,settings.image)}if(name){console.error("Cannot instantiate entity of type '"+data+"': Class not found!")}return null};obj.purge=function(){for(className in entityClass){entityClass[className]["pool"]=[]}};obj.freeInstance=function(obj){var name=obj.className;if(!name||!entityClass[name]){return}var notFound=true;for(var i=0,len=entityClass[name]["active"].length;i<len;i++){if(entityClass[name]["active"][i]===obj){notFound=false;entityClass[name]["active"].splice(i,1);break}}if(notFound){return}entityClass[name]["pool"].push(obj)};return obj})();me.ObjectEntity=me.Renderable.extend({GUID:null,type:0,collidable:true,collisionBox:null,renderable:null,lastflipX:false,lastflipY:false,init:function(x,y,settings){this.parent(new me.Vector2d(x,y),~~settings.spritewidth||~~settings.width,~~settings.spriteheight||~~settings.height);if(settings.image){var image=(typeof settings.image=="string")?me.loader.getImage(settings.image):settings.image;this.renderable=new me.AnimationSheet(0,0,image,~~settings.spritewidth,~~settings.spriteheight,~~settings.spacing,~~settings.margin);if(settings.transparent_color){this.renderable.setTransparency(settings.transparent_color)}}this.GUID=me.utils.createGUID();this.name=settings.name?settings.name.toLowerCase():"";this.vel=new me.Vector2d();this.accel=new me.Vector2d();this.friction=new me.Vector2d();this.maxVel=new me.Vector2d(1000,1000);this.gravity=(me.sys.gravity!=undefined)?me.sys.gravity:0.98;this.isEntity=true;this.alive=true;this.visible=true;this.floating=false;this.isPersistent=false;this.falling=false;this.jumping=true;this.slopeY=0;this.onslope=false;this.onladder=false;this.disableTopLadderCollision=false;this.collidable=typeof(settings.collidable)!=="undefined"?settings.collidable:true;this.type=settings.type||0;this.lastflipX=this.lastflipY=false;this.collisionMap=me.game.collisionMap;this.collisionBox=new me.Rect(this.pos,this.width,this.height);this.canBreakTile=false;this.onTileBreak=null},updateColRect:function(x,w,y,h){this.collisionBox.adjustSize(x,w,y,h)},onCollision:function(res,obj){if(this.collidable&&(this.type==me.game.COLLECTABLE_OBJECT)){me.game.remove(this)}},setVelocity:function(x,y){this.accel.x=(x!=0)?x:this.accel.x;this.accel.y=(y!=0)?y:this.accel.y;this.setMaxVelocity(x,y)},setMaxVelocity:function(x,y){this.maxVel.x=x;this.maxVel.y=y},setFriction:function(x,y){this.friction.x=x||0;this.friction.y=y||0},flipX:function(flip){if(flip!=this.lastflipX){this.lastflipX=flip;if(this.renderable&&this.renderable.flipX){this.renderable.flipX(flip)}this.collisionBox.flipX(this.width)}},flipY:function(flip){if(flip!=this.lastflipY){this.lastflipY=flip;if(this.renderable&&this.renderable.flipY){this.renderable.flipY(flip)}this.collisionBox.flipY(this.height)}},doWalk:function(left){this.flipX(left);this.vel.x+=(left)?-this.accel.x*me.timer.tick:this.accel.x*me.timer.tick},doClimb:function(up){if(this.onladder){this.vel.y=(up)?-this.accel.x*me.timer.tick:this.accel.x*me.timer.tick;this.disableTopLadderCollision=!up;return true}return false},doJump:function(){if(!this.jumping&&!this.falling){this.vel.y=-this.maxVel.y*me.timer.tick;this.jumping=true;return true}return false},forceJump:function(){this.jumping=this.falling=false;this.doJump()},distanceTo:function(e){var dx=(this.pos.x+this.hWidth)-(e.pos.x+e.hWidth);var dy=(this.pos.y+this.hHeight)-(e.pos.y+e.hHeight);return Math.sqrt(dx*dx+dy*dy)},distanceToPoint:function(v){var dx=(this.pos.x+this.hWidth)-(v.x);var dy=(this.pos.y+this.hHeight)-(v.y);return Math.sqrt(dx*dx+dy*dy)},angleTo:function(e){var ax=(e.pos.x+e.hWidth)-(this.pos.x+this.hWidth);var ay=(e.pos.y+e.hHeight)-(this.pos.y+this.hHeight);return Math.atan2(ay,ax)},angleToPoint:function(v){var ax=(v.x)-(this.pos.x+this.hWidth);var ay=(v.y)-(this.pos.y+this.hHeight);return Math.atan2(ay,ax)},checkSlope:function(tile,left){this.pos.y=tile.pos.y-this.height;if(left){this.slopeY=tile.height-(this.collisionBox.right+this.vel.x-tile.pos.x)}else{this.slopeY=(this.collisionBox.left+this.vel.x-tile.pos.x)}this.vel.y=0;this.pos.y+=this.slopeY.clamp(0,tile.height)},computeVelocity:function(vel){if(this.gravity){vel.y+=!this.onladder?(this.gravity*me.timer.tick):0;this.falling=(vel.y>0);this.jumping=this.falling?false:this.jumping}if(this.friction.x){vel.x=me.utils.applyFriction(vel.x,this.friction.x)}if(this.friction.y){vel.y=me.utils.applyFriction(vel.y,this.friction.y)}if(vel.y!=0){vel.y=vel.y.clamp(-this.maxVel.y,this.maxVel.y)}if(vel.x!=0){vel.x=vel.x.clamp(-this.maxVel.x,this.maxVel.x)}},updateMovement:function(){this.computeVelocity(this.vel);if(this.collidable){var collision=this.collisionMap.checkCollision(this.collisionBox,this.vel);this.onslope=collision.yprop.isSlope||collision.xprop.isSlope;this.onladder=false;if(collision.y){this.onladder=collision.yprop.isLadder||collision.yprop.isTopLadder;if(collision.y>0){if(collision.yprop.isSolid||(collision.yprop.isPlatform&&(this.collisionBox.bottom-1<=collision.ytile.pos.y))||(collision.yprop.isTopLadder&&!this.disableTopLadderCollision)){this.pos.y=~~this.pos.y;this.vel.y=(this.falling)?collision.ytile.pos.y-this.collisionBox.bottom:0;this.falling=false}else{if(collision.yprop.isSlope&&!this.jumping){this.checkSlope(collision.ytile,collision.yprop.isLeftSlope);this.falling=false}else{if(collision.yprop.isBreakable){if(this.canBreakTile){me.game.currentLevel.clearTile(collision.ytile.col,collision.ytile.row);if(this.onTileBreak){this.onTileBreak()}}else{this.pos.y=~~this.pos.y;this.vel.y=(this.falling)?collision.ytile.pos.y-this.collisionBox.bottom:0;this.falling=false}}}}}else{if(collision.y<0){if(!collision.yprop.isPlatform&&!collision.yprop.isLadder&&!collision.yprop.isTopLadder){this.falling=true;this.vel.y=0}}}}if(collision.x){this.onladder=collision.xprop.isLadder||collision.yprop.isTopLadder;if(collision.xprop.isSlope&&!this.jumping){this.checkSlope(collision.xtile,collision.xprop.isLeftSlope);this.falling=false}else{if(!collision.xprop.isPlatform&&!collision.xprop.isLadder&&!collision.xprop.isTopLadder){if(collision.xprop.isBreakable&&this.canBreakTile){me.game.currentLevel.clearTile(collision.xtile.col,collision.xtile.row);if(this.onTileBreak){this.onTileBreak()}}else{this.vel.x=0}}}}}this.pos.add(this.vel);return collision},collide:function(multiple){return me.game.collide(this,multiple||false)},collideType:function(type,multiple){return me.game.collideType(this,type,multiple||false)},update:function(){if(this.renderable){return this.renderable.update()}return false},getRect:function(){if(this.renderable){return this.renderable.getRect().translateV(this.pos)}return null},draw:function(context){if(this.renderable){var x=~~(this.pos.x+(this.anchorPoint.x*(this.width-this.renderable.width)));var y=~~(this.pos.y+(this.anchorPoint.y*(this.height-this.renderable.height)));context.translate(x,y);this.renderable.draw(context);context.translate(-x,-y)}if(me.debug.renderHitBox&&this.collisionBox){this.collisionBox.draw(context,"red")}if(me.debug.renderVelocity){var x=~~(this.pos.x+this.hWidth);var y=~~(this.pos.y+this.hHeight);context.strokeStyle="blue";context.lineWidth=1;context.beginPath();context.moveTo(x,y);context.lineTo(x+~~(this.vel.x*this.hWidth),y+~~(this.vel.y*this.hHeight));context.stroke()}},destroy:function(){if(this.renderable){this.renderable.destroy.apply(this.renderable,arguments);this.renderable=null}this.onDestroyEvent.apply(this,arguments);this.pos=null;this.collisionBox=null},onDestroyEvent:function(){}});me.CollectableEntity=me.ObjectEntity.extend({init:function(x,y,settings){this.parent(x,y,settings);this.type=me.game.COLLECTABLE_OBJECT}});me.LevelEntity=me.ObjectEntity.extend({init:function(x,y,settings){this.parent(x,y,settings);this.nextlevel=settings.to;this.fade=settings.fade;this.duration=settings.duration;this.fading=false;this.gotolevel=settings.to},onFadeComplete:function(){me.levelDirector.loadLevel(this.gotolevel);me.game.viewport.fadeOut(this.fade,this.duration)},goTo:function(level){this.gotolevel=level||this.nextlevel;if(this.fade&&this.duration){if(!this.fading){this.fading=true;me.game.viewport.fadeIn(this.fade,this.duration,this.onFadeComplete.bind(this))}}else{me.levelDirector.loadLevel(this.gotolevel)}},onCollision:function(){this.goTo()}})})(window);(function($){me.ScreenObject=me.Renderable.extend({addAsObject:false,visible:false,frame:0,z:999,init:function(addAsObject,isPersistent){this.parent(new me.Vector2d(0,0),0,0);this.addAsObject=this.visible=(addAsObject===true)||false;this.isPersistent=(this.visible&&(isPersistent===true))||false},reset:function(){me.game.reset();this.frame=0;this.frameRate=Math.round(60/me.sys.fps);this.onResetEvent.apply(this,arguments);if(this.addAsObject){this.visible=true;this.set(me.game.viewport.pos,me.game.viewport.width,me.game.viewport.height);me.game.add(this,this.z)}me.game.sort()},destroy:function(){this.onDestroyEvent.apply(this,arguments)},update:function(){return false},onUpdateFrame:function(){if(!(++this.frame%this.frameRate)){this.frame=0;me.timer.update();me.game.update();me.game.draw();me.video.blitSurface()}},draw:function(){},onResetEvent:function(){},onDestroyEvent:function(){}});(function(){var lastTime=0;var vendors=["ms","moz","webkit","o"];var requestAnimationFrame=window.requestAnimationFrame;var cancelAnimationFrame=window.cancelAnimationFrame;for(var x=0;x<vendors.length;++x){if(requestAnimationFrame&&cancelAnimationFrame){break}requestAnimationFrame=window[vendors[x]+"RequestAnimationFrame"];cancelAnimationFrame=window[vendors[x]+"CancelAnimationFrame"]||window[vendors[x]+"CancelRequestAnimationFrame"]}if(!requestAnimationFrame||!cancelAnimationFrame){requestAnimationFrame=function(callback,element){var currTime=Date.now();var timeToCall=Math.max(0,16-(currTime-lastTime));var id=window.setTimeout(function(){callback(currTime+timeToCall)},timeToCall);lastTime=currTime+timeToCall;return id};cancelAnimationFrame=function(id){window.clearTimeout(id)}}window.requestAnimationFrame=requestAnimationFrame;window.cancelAnimationFrame=cancelAnimationFrame}());me.state=(function(){var obj={};var _state=-1;var _animFrameId=-1;var _screenObject={};var _fade={color:"",duration:0};var _onSwitchComplete=null;var _extraArgs=null;var _activeUpdateFrame=null;function _startRunLoop(){if((_animFrameId===-1)&&(_state!==-1)){me.timer.reset();_animFrameId=window.requestAnimationFrame(_renderFrame)}}function _renderFrame(){_activeUpdateFrame();if(_animFrameId!=-1){_animFrameId=window.requestAnimationFrame(_renderFrame)}}function _stopRunLoop(){window.cancelAnimationFrame(_animFrameId);_animFrameId=-1}function _switchState(state){_stopRunLoop();if(_screenObject[_state]){if(_screenObject[_state].screen.visible){me.game.remove.call(me.game,_screenObject[_state].screen,true)}_screenObject[_state].screen.destroy()}if(_screenObject[state]){_state=state;_screenObject[_state].screen.reset.apply(_screenObject[_state].screen,_extraArgs);_activeUpdateFrame=_screenObject[_state].screen.onUpdateFrame.bind(_screenObject[_state].screen);_startRunLoop();if(_onSwitchComplete){_onSwitchComplete()}me.game.repaint()}}obj.LOADING=0;obj.MENU=1;obj.READY=2;obj.PLAY=3;obj.GAMEOVER=4;obj.GAME_END=5;obj.SCORE=6;obj.CREDITS=7;obj.SETTINGS=8;obj.USER=100;obj.onPause=null;obj.onResume=null;obj.init=function(){obj.set(obj.LOADING,me.loadingScreen);$.addEventListener("blur",function(){if(me.sys.pauseOnBlur&&(_state!=obj.LOADING)){obj.pause(true)}if(obj.onPause){obj.onPause()}me.event.publish(me.event.STATE_PAUSE)},false);$.addEventListener("focus",function(){if(me.sys.pauseOnBlur&&(_state!=obj.LOADING)){obj.resume(true);me.game.repaint()}if(obj.onResume){obj.onResume()}me.event.publish(me.event.STATE_RESUME)},false)};obj.pause=function(music){_stopRunLoop();if(music){me.audio.pauseTrack()}};obj.resume=function(music){_startRunLoop();if(music){me.audio.resumeTrack()}};obj.isRunning=function(){return(_animFrameId!==-1)};obj.set=function(state,so){_screenObject[state]={};_screenObject[state].screen=so;_screenObject[state].transition=true};obj.current=function(){return _screenObject[_state].screen};obj.transition=function(effect,color,duration){if(effect=="fade"){_fade.color=color;_fade.duration=duration}};obj.setTransition=function(state,enable){_screenObject[state].transition=enable};obj.change=function(state){if(typeof(_screenObject[state])==="undefined"){throw"melonJS : Undefined ScreenObject for state '"+state+"'"}_extraArgs=null;if(arguments.length>1){_extraArgs=Array.prototype.slice.call(arguments,1)}if(_fade.duration&&_screenObject[state].transition){_onSwitchComplete=function(){me.game.viewport.fadeOut(_fade.color,_fade.duration)};me.game.viewport.fadeIn(_fade.color,_fade.duration,function(){_switchState.defer(state)})}else{_switchState.defer(state)}};obj.isCurrent=function(state){return _state==state};return obj})()})(window);(function($){me.DefaultLoadingScreen=me.ScreenObject.extend({init:function(){this.parent(true);this.invalidate=false;this.handle=null},onResetEvent:function(){this.logo1=new me.Font("century gothic",32,"white","middle");this.logo2=new me.Font("century gothic",32,"#89b002","middle");this.logo2.bold();this.logo1.textBaseline=this.logo2.textBaseline="alphabetic";this.handle=me.event.subscribe(me.event.LOADER_PROGRESS,this.onProgressUpdate.bind(this));this.loadPercent=0},onDestroyEvent:function(){this.logo1=this.logo2=null;if(this.handle){me.event.unsubscribe(this.handle);this.handle=null}},onProgressUpdate:function(progress){this.loadPercent=progress;this.invalidate=true},update:function(){if(this.invalidate===true){this.invalidate=false;return true}return false},draw:function(context){var logo1_width=this.logo1.measureText(context,"melon").width;var xpos=(me.video.getWidth()-logo1_width-this.logo2.measureText(context,"JS").width)/2;var ypos=me.video.getHeight()/2;me.video.clearSurface(context,"black");this.logo1.draw(context,"melon",xpos,ypos);xpos+=logo1_width;this.logo2.draw(context,"JS",xpos,ypos);ypos+=this.logo1.measureText(context,"melon").height/2;var progress=Math.floor(this.loadPercent*me.video.getWidth());context.strokeStyle="silver";context.strokeRect(0,ypos,me.video.getWidth(),6);context.fillStyle="#89b002";context.fillRect(2,ypos+2,progress-4,2)}});me.loader=(function(){var obj={};var imgList={};var tmxList={};var binList={};var atlasList={};var jsonList={};var resourceCount=0;var loadCount=0;var timerId=0;function checkLoadStatus(){if(loadCount==resourceCount){if(obj.onload){clearTimeout(timerId);setTimeout(function(){obj.onload();me.event.publish(me.event.LOADER_COMPLETE)},300)}else{console.error("no load callback defined")}}else{timerId=setTimeout(checkLoadStatus,100)}}function preloadImage(img,onload,onerror){imgList[img.name]=new Image();imgList[img.name].onload=onload;imgList[img.name].onerror=onerror;imgList[img.name].src=img.src+me.nocache}function preloadTMX(tmxData,onload,onerror){var xmlhttp=new XMLHttpRequest();var format=me.utils.getFileExtension(tmxData.src).toLowerCase();if(xmlhttp.overrideMimeType){if(format==="json"){xmlhttp.overrideMimeType("application/json")}else{xmlhttp.overrideMimeType("text/xml")}}xmlhttp.open("GET",tmxData.src+me.nocache,true);if(tmxData.type==="tmx"){me.levelDirector.addTMXLevel(tmxData.name)}xmlhttp.ontimeout=onerror;xmlhttp.onreadystatechange=function(){if(xmlhttp.readyState==4){if((xmlhttp.status==200)||((xmlhttp.status==0)&&xmlhttp.responseText)){var result=null;switch(format){case"xml":case"tmx":if(me.sys.ua.match(/msie/i)||!xmlhttp.responseXML){result=(new DOMParser()).parseFromString(xmlhttp.responseText,"text/xml")}else{result=xmlhttp.responseXML}format="xml";break;case"json":result=JSON.parse(xmlhttp.responseText);break;default:throw"melonJS: TMX file format "+format+"not supported !"}tmxList[tmxData.name]={data:result,isTMX:(tmxData.type==="tmx"),format:format};onload()}else{onerror()}}};xmlhttp.send(null)}function preloadJSON(data,onload,onerror){var xmlhttp=new XMLHttpRequest();if(xmlhttp.overrideMimeType){xmlhttp.overrideMimeType("application/json")}xmlhttp.open("GET",data.src+me.nocache,true);xmlhttp.ontimeout=onerror;xmlhttp.onreadystatechange=function(){if(xmlhttp.readyState==4){if((xmlhttp.status==200)||((xmlhttp.status==0)&&xmlhttp.responseText)){jsonList[data.name]=JSON.parse(xmlhttp.responseText);onload()}else{onerror()}}};xmlhttp.send(null)}function preloadBinary(data,onload,onerror){var httpReq=new XMLHttpRequest();httpReq.open("GET",data.src+me.nocache,false);httpReq.responseType="arraybuffer";httpReq.onerror=onerror;httpReq.onload=function(event){var arrayBuffer=httpReq.response;if(arrayBuffer){var byteArray=new Uint8Array(arrayBuffer);var buffer=[];binList[data.name]=new dataType();for(var i=0;i<byteArray.byteLength;i++){buffer[i]=String.fromCharCode(byteArray[i])}binList[data.name].data=buffer.join("");onload()}};httpReq.send()}obj.onload=undefined;obj.onProgress=undefined;obj.onResourceLoaded=function(e){loadCount++;var progress=obj.getLoadProgress();if(obj.onProgress){obj.onProgress(progress)}me.event.publish(me.event.LOADER_PROGRESS,[progress])};obj.onLoadingError=function(res){throw"melonJS: Failed loading resource "+res.src};obj.preload=function(res){for(var i=0;i<res.length;i++){resourceCount+=obj.load(res[i],obj.onResourceLoaded.bind(obj),obj.onLoadingError.bind(obj,res[i]))}checkLoadStatus()};obj.load=function(res,onload,onerror){res.name=res.name.toLowerCase();switch(res.type){case"binary":preloadBinary.call(this,res,onload,onerror);return 1;case"image":preloadImage.call(this,res,onload,onerror);return 1;case"json":preloadJSON.call(this,res,onload,onerror);return 1;case"tmx":case"tsx":preloadTMX.call(this,res,onload,onerror);return 1;case"audio":if(me.audio.isAudioEnable()){me.audio.load(res,onload,onerror);return 1}break;default:throw"melonJS: me.loader.load : unknown or invalid resource type : "+res.type;break}return 0};obj.unload=function(res){res.name=res.name.toLowerCase();switch(res.type){case"binary":if(!(res.name in binList)){return false}delete binList[res.name];return true;case"image":if(!(res.name in imgList)){return false}delete imgList[res.name];return true;case"json":if(!(res.name in jsonList)){return false}delete jsonList[res.name];return true;case"tmx":case"tsx":if(!(res.name in tmxList)){return false}delete tmxList[res.name];return true;case"audio":return me.audio.unload(res.name);default:throw"melonJS: me.loader.unload : unknown or invalid resource type : "+res.type}};obj.unloadAll=function(){var name;for(name in binList){obj.unload(name)}for(name in imgList){obj.unload(name)}for(name in tmxList){obj.unload(name)}for(name in atlasList){obj.unload(name)}for(name in jsonList){obj.unload(name)}me.audio.unloadAll()};obj.getTMXFormat=function(elt){elt=elt.toLowerCase();if(elt in tmxList){return tmxList[elt].format}else{return null}};obj.getTMX=function(elt){elt=elt.toLowerCase();if(elt in tmxList){return tmxList[elt].data}else{return null}};obj.getBinary=function(elt){elt=elt.toLowerCase();if(elt in binList){return binList[elt]}else{return null}};obj.getImage=function(elt){elt=elt.toLowerCase();if(elt in imgList){if(me.sys.cacheImage===true){var tempCanvas=me.video.createCanvasSurface(imgList[elt].width,imgList[elt].height);tempCanvas.drawImage(imgList[elt],0,0);return tempCanvas.canvas}else{return imgList[elt]}}else{return null}};obj.getJSON=function(elt){elt=elt.toLowerCase();if(elt in jsonList){return jsonList[elt]}else{return null}};obj.getLoadProgress=function(){return loadCount/resourceCount};return obj})()})(window);(function($){me.Font=Object.extend({font:null,height:null,color:null,textAlign:"left",textBaseline:"top",lineHeight:1,init:function(font,size,color,textAlign){this.set(font,size,color,textAlign)},bold:function(){this.font="bold "+this.font},italic:function(){this.font="italic "+this.font},set:function(font,size,color,textAlign){var font_names=font.split(",");for(var i=0;i<font_names.length;i++){font_names[i]="'"+font_names[i]+"'"}this.height=parseInt(size);if(typeof size==="number"){size=""+size+"px"}this.font=size+" "+font_names.join(",");this.color=color;if(textAlign){this.textAlign=textAlign}},getRect:function(){return new me.Rect(new Vector2d(0,0),0,0)},measureText:function(context,text){context.font=this.font;context.fillStyle=this.color;context.textAlign=this.textAlign;context.textBaseline=this.textBaseline;var strings=(""+text).split("\n");var width=0,height=0;for(var i=0;i<strings.length;i++){width=Math.max(context.measureText(strings[i].trim()).width,width);height+=this.height*this.lineHeight}return{width:width,height:height}},draw:function(context,text,x,y){context.font=this.font;context.fillStyle=this.color;context.textAlign=this.textAlign;context.textBaseline=this.textBaseline;var strings=(""+text).split("\n");for(var i=0;i<strings.length;i++){context.fillText(strings[i].trim(),~~x,~~y);y+=this.height*this.lineHeight}}});me.BitmapFont=me.Font.extend({size:null,sSize:null,firstChar:32,charCount:0,init:function(font,size,scale,firstChar){this.parent(font,null,null);this.size=new me.Vector2d();this.sSize=new me.Vector2d();this.firstChar=firstChar||32;this.loadFontMetrics(font,size);this.textAlign="left";this.textBaseline="top";if(scale){this.resize(scale)}},loadFontMetrics:function(font,size){this.font=me.loader.getImage(font);this.size.x=size.x||size;this.size.y=size.y||this.font.height;this.sSize.copy(this.size);this.charCount=~~(this.font.width/this.size.x)},set:function(textAlign,scale){this.textAlign=textAlign;if(scale){this.resize(scale)}},resize:function(scale){this.sSize.setV(this.size);this.sSize.x*=scale;this.sSize.y*=scale},measureText:function(context,text){var strings=(""+text).split("\n");var width=0,height=0;for(var i=0;i<strings.length;i++){width=Math.max((strings[i].trim().length*this.sSize.x),width);height+=this.sSize.y*this.lineHeight}return{width:width,height:height}},draw:function(context,text,x,y){var strings=(""+text).split("\n");var lX=x;var height=this.sSize.y*this.lineHeight;for(var i=0;i<strings.length;i++){var x=lX,y=y;var string=strings[i].trim();var width=string.length*this.sSize.x;switch(this.textAlign){case"right":x-=width;break;case"center":x-=width*0.5;break;default:break}switch(this.textBaseline){case"middle":y-=height*0.5;break;case"ideographic":case"alphabetic":case"bottom":y-=height;break;default:break}for(var c=0,len=string.length;c<len;c++){var idx=string.charCodeAt(c)-this.firstChar;if(idx>=0){context.drawImage(this.font,this.size.x*(idx%this.charCount),this.size.y*~~(idx/this.charCount),this.size.x,this.size.y,~~x,~~y,this.sSize.x,this.sSize.y)}x+=this.sSize.x}y+=height}}})})(window);(function($){me.GUI_Object=me.SpriteObject.extend({isClickable:true,updated:false,init:function(x,y,settings){this.parent(x,y,((typeof settings.image=="string")?me.loader.getImage(settings.image):settings.image),settings.spritewidth,settings.spriteheight);this.floating=true;me.input.registerPointerEvent("mousedown",this,this.clicked.bind(this))},update:function(){if(this.updated){this.updated=false;return true}return false},clicked:function(){if(this.isClickable){this.updated=true;return this.onClick()}},onClick:function(){return true},onDestroyEvent:function(){me.input.releasePointerEvent("mousedown",this)}})})(window);(function($){me.HUD_Item=Object.extend({init:function(x,y,val){this.pos=new me.Vector2d(x||0,y||0);this.visible=true;this.defaultvalue=val||0;this.value=val||0;this.updated=true},reset:function(){this.set(this.defaultvalue)},set:function(value){this.value=value;this.updated=true;return true},update:function(value){return this.set(this.value+value)},draw:function(context,x,y){}});me.HUD_Object=me.Renderable.extend({init:function(x,y,w,h,bg){this.parent(new me.Vector2d(x||0,y||0),w||me.video.getWidth(),h||me.video.getHeight());this.bgcolor=bg;this.HUDItems={};this.HUDobj=[];this.objCount=0;this.visible=true;this.floating=true;this.HUD_invalidated=true;this.HUDCanvas=me.video.createCanvas(this.width,this.height);this.HUDCanvasSurface=this.HUDCanvas.getContext("2d");me.video.setImageSmoothing(this.HUDCanvasSurface,me.sys.scalingInterpolation);this.z=999;this.isPersistent=true},addItem:function(name,item){this.HUDItems[name]=item;this.HUDobj.push(this.HUDItems[name]);this.objCount++;this.HUD_invalidated=true},removeItem:function(name){if(this.HUDItems[name]){this.HUDobj.splice(this.HUDobj.indexOf(this.HUDItems[name]),1);this.HUDItems[name]=null;this.objCount--;this.HUD_invalidated=true}},setItemValue:function(name,value){if(this.HUDItems[name]&&(this.HUDItems[name].set(value)==true)){this.HUD_invalidated=true}},updateItemValue:function(name,value){if(this.HUDItems[name]&&(this.HUDItems[name].update(value)==true)){this.HUD_invalidated=true}},getItemValue:function(name){return(this.HUDItems[name])?this.HUDItems[name].value:0},update:function(){return this.HUD_invalidated},reset:function(name){if(name!=undefined){if(this.HUDItems[name]){this.HUDItems[name].reset()}this.HUD_invalidated=true}else{this.resetAll()}},resetAll:function(){for(var i=this.objCount,obj;i--,obj=this.HUDobj[i];){obj.reset()}this.HUD_invalidated=true},draw:function(context){if(this.HUD_invalidated){if(this.bgcolor){me.video.clearSurface(this.HUDCanvasSurface,this.bgcolor)}else{this.HUDCanvas.width=this.HUDCanvas.width}for(var i=this.objCount,obj;i--,obj=this.HUDobj[i];){if(obj.visible){obj.draw(this.HUDCanvasSurface,0,0);if(obj.updated){obj.updated=false}}}}context.drawImage(this.HUDCanvas,this.pos.x,this.pos.y);this.HUD_invalidated=false}})})(window);(function($){me.audio=(function(){var obj={};var audio_channels={};var activeAudioExt=-1;var current_track_id=null;var current_track=null;var sound_enable=true;var reset_val=0;var retry_counter=0;var settings={volume:1,muted:false};var sync_loading=false;var sync_loader=[];function getSupportedAudioFormat(requestedFormat){var result="";var len=requestedFormat.length;if(me.sys.sound){var ext="";for(var i=0;i<len;i++){ext=requestedFormat[i].toLowerCase().trim();if(obj.capabilities[ext]&&obj.capabilities[ext].canPlay&&(result===""||obj.capabilities[ext].canPlayType==="probably")){result=ext;if(obj.capabilities[ext].canPlayType==="probably"){break}}}}if(result===""){sound_enable=false}return result}function get(sound_id){var channels=audio_channels[sound_id];for(var i=0,soundclip;soundclip=channels[i++];){if(soundclip.ended||!soundclip.currentTime){soundclip.currentTime=reset_val;return soundclip}}channels[0].pause();channels[0].currentTime=reset_val;return channels[0]}function soundLoadError(sound_id,onerror_cb){if(retry_counter++>3){var errmsg="melonJS: failed loading "+sound_id+"."+activeAudioExt;if(me.sys.stopOnAudioError===false){me.audio.disable();if(onerror_cb){onerror_cb()}console.log(errmsg+", disabling audio")}else{throw errmsg}}else{audio_channels[sound_id][0].load()}}function soundLoaded(sound_id,sound_channel,onload_cb){retry_counter=0;if(sound_channel>1){var soundclip=audio_channels[sound_id][0];for(var channel=1;channel<sound_channel;channel++){audio_channels[sound_id][channel]=new Audio(soundclip.src);audio_channels[sound_id][channel].preload="auto";audio_channels[sound_id][channel].load()}}if(onload_cb){onload_cb()}}function _play_audio_enable(sound_id,loop,callback,volume){var soundclip=get(sound_id.toLowerCase());soundclip.loop=loop||false;soundclip.volume=volume?parseFloat(volume).clamp(0,1):settings.volume;soundclip.muted=settings.muted;soundclip.play();if(callback&&!loop){soundclip.addEventListener("ended",function(event){soundclip.removeEventListener("ended",arguments.callee,false);callback()},false)}return soundclip}function _play_audio_disable(sound_id,loop,callback){if(callback&&!loop){setTimeout(callback,2000)}return null}obj.capabilities={mp3:{codec:"audio/mpeg",canPlay:false,canPlayType:"no"},ogg:{codec:'audio/ogg; codecs="vorbis"',canPlay:false,canPlayType:"no"},m4a:{codec:'audio/mp4; codecs="mp4a.40.2"',canPlay:false,canPlayType:"no"},wav:{codec:'audio/wav; codecs="1"',canPlay:false,canPlayType:"no"}};obj.detectCapabilities=function(){var a=document.createElement("audio");if(a.canPlayType){for(var c in obj.capabilities){var canPlayType=a.canPlayType(obj.capabilities[c].codec);if(canPlayType!==""&&canPlayType!=="no"){obj.capabilities[c].canPlay=true;obj.capabilities[c].canPlayType=canPlayType}me.sys.sound|=obj.capabilities[c].canPlay}}};obj.init=function(audioFormat){if(!me.initialized){throw"melonJS: me.audio.init() called before engine initialization."}audioFormat=new String(audioFormat?audioFormat:"mp3");audioFormat=audioFormat.split(",");activeAudioExt=getSupportedAudioFormat(audioFormat);if(me.sys.isMobile&&!navigator.isCocoonJS){sound_enable=false}obj.play=obj.isAudioEnable()?_play_audio_enable:_play_audio_disable;return obj.isAudioEnable()};obj.isAudioEnable=function(){return sound_enable};obj.enable=function(){sound_enable=me.sys.sound;if(sound_enable){obj.play=_play_audio_enable}else{obj.play=_play_audio_disable}};obj.disable=function(){me.audio.stopTrack();obj.play=_play_audio_disable;sound_enable=false};obj.load=function(sound,onload_cb,onerror_cb){if(activeAudioExt==-1){return 0}if(me.sys.isMobile&&!navigator.isCocoonJS){if(sync_loading){sync_loader.push([sound,onload_cb,onerror_cb]);return}sync_loading=true}var channels=sound.channel||1;var eventname="canplaythrough";if(sound.stream===true&&!me.sys.isMobile){channels=1;eventname="canplay"}var soundclip=new Audio(sound.src+sound.name+"."+activeAudioExt+me.nocache);soundclip.preload="auto";soundclip.addEventListener(eventname,function(e){soundclip.removeEventListener(eventname,arguments.callee,false);sync_loading=false;soundLoaded.call(me.audio,sound.name,channels,onload_cb);var next=sync_loader.shift();if(next){obj.load.apply(obj,next)}},false);soundclip.addEventListener("error",function(e){soundLoadError.call(me.audio,sound.name,onerror_cb)},false);soundclip.load();audio_channels[sound.name]=[soundclip];return 1};obj.stop=function(sound_id){if(sound_enable){var sound=audio_channels[sound_id.toLowerCase()];for(var channel_id=sound.length;channel_id--;){sound[channel_id].pause();sound[channel_id].currentTime=reset_val}}};obj.pause=function(sound_id){if(sound_enable){var sound=audio_channels[sound_id.toLowerCase()];for(var channel_id=sound.length;channel_id--;){sound[channel_id].pause()}}};obj.playTrack=function(sound_id,volume){current_track=me.audio.play(sound_id,true,null,volume);current_track_id=sound_id.toLowerCase()};obj.stopTrack=function(){if(sound_enable&&current_track){current_track.pause();current_track_id=null;current_track=null}};obj.setVolume=function(volume){if(typeof(volume)==="number"){settings.volume=volume.clamp(0,1)}};obj.getVolume=function(){return settings.volume};obj.mute=function(sound_id,mute){mute=(mute===undefined)?true:!!mute;var channels=audio_channels[sound_id.toLowerCase()];for(var i=0,soundclip;soundclip=channels[i++];){soundclip.muted=mute}},obj.unmute=function(sound_id){obj.mute(sound_id,false)},obj.muteAll=function(){settings.muted=true;for(var sound_id in audio_channels){obj.mute(sound_id,settings.muted)}};obj.unmuteAll=function(){settings.muted=false;for(var sound_id in audio_channels){obj.mute(sound_id,settings.muted)}};obj.getCurrentTrack=function(){return current_track_id};obj.pauseTrack=function(){if(sound_enable&&current_track){current_track.pause()}};obj.resumeTrack=function(){if(sound_enable&&current_track){current_track.play()}};obj.unload=function(sound_id){sound_id=sound_id.toLowerCase();if(!(sound_id in audio_channels)){return false}if(current_track_id===sound_id){obj.stopTrack()}else{obj.stop(sound_id)}delete audio_channels[sound_id];return true};obj.unloadAll=function(){for(var sound_id in audio_channels){obj.unload(sound_id)}};return obj})()})(window);(function($){me.timer=(function(){var api={};var htmlCounter=null;var debug=false;var framecount=0;var framedelta=0;var last=0;var now=0;var delta=0;var step=Math.ceil(1000/me.sys.fps);var minstep=(1000/me.sys.fps)*1.25;function draw(fps){htmlCounter.replaceChild(document.createTextNode("("+fps+"/"+me.sys.fps+" fps)"),htmlCounter.firstChild)}api.tick=1;api.fps=0;api.init=function(){htmlCounter=document.getElementById("framecounter");if(htmlCounter!==null){me.debug.displayFPS=true}api.reset()};api.reset=function(){now=last=Date.now();framedelta=0;framecount=0};api.getTime=function(){return now};api.update=function(){last=now;now=Date.now();delta=(now-last);if(me.debug.displayFPS){framecount++;framedelta+=delta;if(framecount%10==0){this.fps=(~~((1000*framecount)/framedelta)).clamp(0,me.sys.fps);framedelta=0;framecount=0}if(htmlCounter!==null){draw(this.fps)}}api.tick=(delta>minstep&&me.sys.interpolation)?delta/step:1};return api})();me.video=(function(){var api={};var canvas=null;var context2D=null;var backBufferCanvas=null;var backBufferContext2D=null;var wrapper=null;var deferResizeId=-1;var double_buffering=false;var game_width_zoom=0;var game_height_zoom=0;var auto_scale=false;var maintainAspectRatio=true;var maxWidth=Infinity;var maxHeight=Infinity;function getCanvasType(){if(navigator.isCocoonJS){if(!me.sys.dirtyRegion){return"screencanvas"}}return"canvas"}api.init=function(wrapperid,game_width,game_height,doublebuffering,scale,aspectRatio){if(!me.initialized){throw"melonJS: me.video.init() called before engine initialization."}double_buffering=doublebuffering||false;auto_scale=(scale==="auto")||false;maintainAspectRatio=(aspectRatio!==undefined)?aspectRatio:true;scale=(scale!=="auto")?parseFloat(scale||1):1;me.sys.scale=new me.Vector2d(scale,scale);if(auto_scale||(scale!==1)){double_buffering=true}game_width_zoom=game_width*me.sys.scale.x;game_height_zoom=game_height*me.sys.scale.y;window.addEventListener("resize",function(event){me.event.publish(me.event.WINDOW_ONRESIZE,[event])},false);window.addEventListener("orientationchange",function(event){me.event.publish(me.event.WINDOW_ONRESIZE,[event])},false);me.event.subscribe(me.event.WINDOW_ONRESIZE,me.video.onresize.bind(me.video));canvas=api.createCanvas(game_width_zoom,game_height_zoom,true);if(wrapperid){wrapper=document.getElementById(wrapperid)}if(!wrapper){wrapper=document.body}wrapper.appendChild(canvas);if(!canvas.getContext){return false}context2D=canvas.getContext("2d");if(!context2D.canvas){context2D.canvas=canvas}me.video.setImageSmoothing(context2D,me.sys.scalingInterpolation);if(double_buffering){backBufferCanvas=api.createCanvas(game_width,game_height,false);backBufferContext2D=backBufferCanvas.getContext("2d");if(!backBufferContext2D.canvas){backBufferContext2D.canvas=backBufferCanvas}me.video.setImageSmoothing(backBufferContext2D,me.sys.scalingInterpolation)}else{backBufferCanvas=canvas;backBufferContext2D=context2D}if(window.getComputedStyle){var style=window.getComputedStyle(canvas,null);me.video.setMaxSize(parseInt(style.maxWidth),parseInt(style.maxHeight))}if(auto_scale){me.video.onresize(null)}return true};api.getWrapper=function(){return wrapper};api.getWidth=function(){return backBufferCanvas.width};api.getPos=function(c){var c=c||canvas;return c.getBoundingClientRect?c.getBoundingClientRect():{left:0,top:0}};api.getHeight=function(){return backBufferCanvas.height};api.setMaxSize=function(w,h){maxWidth=w||Infinity;maxHeight=h||Infinity};api.createCanvas=function(width,height,vendorExt){if(width===0||height===0){throw new Error("melonJS: width or height was zero, Canvas could not be initialized !")}var canvasType=(vendorExt===true)?getCanvasType():"canvas";var _canvas=document.createElement(canvasType);_canvas.width=width||backBufferCanvas.width;_canvas.height=height||backBufferCanvas.height;return _canvas};api.createCanvasSurface=function(width,height){var _canvas=api.createCanvas(width,height,false);var _context=_canvas.getContext("2d");if(!_context.canvas){_context.canvas=_canvas}me.video.setImageSmoothing(_context,me.sys.scalingInterpolation);return _context};api.getScreenCanvas=function(){return canvas};api.getScreenContext=function(){return context2D};api.getSystemCanvas=function(){return backBufferCanvas};api.getSystemContext=function(){return backBufferContext2D};api.onresize=function(event){if(auto_scale){var parent=me.video.getScreenCanvas().parentNode;var _max_width=Math.min(maxWidth,parent.width||window.innerWidth);var _max_height=Math.min(maxHeight,parent.height||window.innerHeight);if(deferResizeId){clearTimeout(deferResizeId)}if(maintainAspectRatio){var designRatio=me.video.getWidth()/me.video.getHeight();var screenRatio=_max_width/_max_height;if(screenRatio<designRatio){var scale=_max_width/me.video.getWidth()}else{var scale=_max_height/me.video.getHeight()}deferResizeId=me.video.updateDisplaySize.defer(scale,scale)}else{deferResizeId=me.video.updateDisplaySize.defer(_max_width/me.video.getWidth(),_max_height/me.video.getHeight())}return}me.input.offset=me.video.getPos()};api.updateDisplaySize=function(scaleX,scaleY){me.sys.scale.set(scaleX,scaleY);canvas.width=game_width_zoom=backBufferCanvas.width*scaleX;canvas.height=game_height_zoom=backBufferCanvas.height*scaleY;me.input.offset=me.video.getPos();api.blitSurface();deferResizeId=-1};api.clearSurface=function(context,col){var w=context.canvas.width;var h=context.canvas.height;context.save();context.setTransform(1,0,0,1,0,0);if(col.substr(0,4)==="rgba"){context.clearRect(0,0,w,h)}context.fillStyle=col;context.fillRect(0,0,w,h);context.restore()};api.scale=function(context,scale){context.translate(-(((context.canvas.width*scale)-context.canvas.width)>>1),-(((context.canvas.height*scale)-context.canvas.height)>>1));context.scale(scale,scale)};api.setImageSmoothing=function(context,enable){var vendors=["ms","moz","webkit","o"];for(var x=0;x<vendors.length;++x){if(context[vendors[x]+"ImageSmoothingEnabled"]!==undefined){context[vendors[x]+"ImageSmoothingEnabled"]=(enable===true)}}context.imageSmoothingEnabled=(enable===true)};api.setAlpha=function(context,enable){context.globalCompositeOperation=enable?"source-over":"copy"};api.blitSurface=function(){if(double_buffering){api.blitSurface=function(){context2D.drawImage(backBufferCanvas,0,0,backBufferCanvas.width,backBufferCanvas.height,0,0,game_width_zoom,game_height_zoom)}}else{api.blitSurface=function(){}}api.blitSurface()};api.applyRGBFilter=function(object,effect,option){var fcanvas=api.createCanvasSurface(object.width,object.height,false);var imgpix=me.utils.getPixels(object);var pix=imgpix.data;switch(effect){case"b&w":for(var i=0,n=pix.length;i<n;i+=4){var grayscale=(3*pix[i]+4*pix[i+1]+pix[i+2])>>>3;pix[i]=grayscale;pix[i+1]=grayscale;pix[i+2]=grayscale}break;case"brightness":var brightness=Math.abs(option).clamp(0,1);for(var i=0,n=pix.length;i<n;i+=4){pix[i]*=brightness;pix[i+1]*=brightness;pix[i+2]*=brightness}break;case"transparent":for(var i=0,n=pix.length;i<n;i+=4){if(me.utils.RGBToHex(pix[i],pix[i+1],pix[i+2])===option){pix[i+3]=0}}break;default:return null}fcanvas.putImageData(imgpix,0,0);return fcanvas};return api})()})(window);(function(window){me.input=(function(){var obj={};var KeyBinding={};var keyStatus={};var keyLock={};var keyLocked={};var evtHandlers={};var keyboardInitialized=false;var pointerInitialized=false;var accelInitialized=false;var lastTimeStamp=0;var activeEventList=null;var mouseEventList=["mousewheel","mousemove","mousedown","mouseup","click","dblclick"];var touchEventList=[undefined,"touchmove","touchstart","touchend","tap","dbltap"];var pointerEventList=[undefined,"PointerMove","PointerDown","PointerUp",undefined,undefined];function enableKeyboardEvent(){if(!keyboardInitialized){window.addEventListener("keydown",keydown,false);window.addEventListener("keyup",keyup,false);keyboardInitialized=true}}function registerEventListener(eventList,callback){for(var x=2;x<eventList.length;++x){if(eventList[x]!==undefined){me.video.getScreenCanvas().addEventListener(eventList[x],callback,false)}}}function enablePointerEvent(){if(!pointerInitialized){obj.changedTouches.push({x:0,y:0});obj.mouse.pos=new me.Vector2d(0,0);obj.offset=me.video.getPos();window.addEventListener("scroll",throttle(100,false,function(e){obj.offset=me.video.getPos();me.event.publish(me.event.WINDOW_ONSCROLL,[e])}),false);if(window.navigator.pointerEnabled){activeEventList=pointerEventList;var useMSPrefix=window.navigator.msPointerEnabled;for(var x=0;x<activeEventList.length;++x){if(activeEventList[x]&&!activeEventList[x].contains("MS")){activeEventList[x]=useMSPrefix?"MS"+activeEventList[x]:activeEventList[x].toLowerCase()}}registerEventListener(activeEventList,onPointerEvent)}else{if(me.sys.touch){activeEventList=touchEventList;registerEventListener(activeEventList,onPointerEvent)}else{activeEventList=mouseEventList;window.addEventListener("mousewheel",onMouseWheel,false);registerEventListener(activeEventList,onPointerEvent)}}if(obj.throttlingInterval===undefined){obj.throttlingInterval=Math.floor(1000/me.sys.fps)}if(obj.throttlingInterval<17){me.video.getScreenCanvas().addEventListener(activeEventList[1],onMoveEvent,false)}else{me.video.getScreenCanvas().addEventListener(activeEventList[1],throttle(obj.throttlingInterval,false,function(e){onMoveEvent(e)}),false)}pointerInitialized=true}}function preventDefault(e){if(e.stopPropagation){e.stopPropagation()}else{e.cancelBubble=true}if(e.preventDefault){e.preventDefault()}else{e.returnValue=false}return false}function keydown(e,keyCode){var action=KeyBinding[keyCode||e.keyCode||e.which];if(action){if(!keyLocked[action]){keyStatus[action]=true;keyLocked[action]=keyLock[action];me.event.publish(me.event.KEYDOWN,[action])}return preventDefault(e)}return true}function keyup(e,keyCode){var action=KeyBinding[keyCode||e.keyCode||e.which];if(action){keyStatus[action]=false;keyLocked[action]=false;me.event.publish(me.event.KEYUP,[action]);return preventDefault(e)}return true}function dispatchEvent(e){var handled=false;var handlers=evtHandlers[e.type];if(handlers){var offset=me.game.viewport.screenToWorld(0,0);for(var t=0,l=obj.changedTouches.length;t<l;t++){if(typeof(e.timeStamp)!=="undefined"){if(e.timeStamp<lastTimeStamp){continue}lastTimeStamp=e.timeStamp}if(!navigator.pointerEnabled){e.pointerId=obj.changedTouches[t].id}e.gameScreenX=obj.changedTouches[t].x;e.gameScreenY=obj.changedTouches[t].y;e.gameWorldX=e.gameScreenX+offset.x;e.gameWorldY=e.gameScreenY+offset.y;for(var i=handlers.length,handler;i--,handler=handlers[i];){if(handler.floating===true){e.gameX=e.gameScreenX;e.gameY=e.gameScreenY}else{e.gameX=e.gameWorldX;e.gameY=e.gameWorldY}if((handler.rect===null)||handler.rect.containsPoint(e.gameX,e.gameY)){if(handler.cb(e)===false){handled=true;break}}}}}return handled}function updateCoordFromEvent(e){obj.changedTouches.length=0;if(!e.touches){var local=obj.globalToLocal(e.clientX,e.clientY);local.id=e.pointerId||1;obj.changedTouches.push(local)}else{for(var i=0,l=e.changedTouches.length;i<l;i++){var t=e.changedTouches[i];var local=obj.globalToLocal(t.clientX,t.clientY);local.id=t.identifier;obj.changedTouches.push(local)}}if(e.isPrimary===false){return}obj.mouse.pos.set(obj.changedTouches[0].x,obj.changedTouches[0].y)}function onMouseWheel(e){if(e.target==me.video.getScreenCanvas()){if(dispatchEvent(e)){return preventDefault(e)}}return true}function onMoveEvent(e){updateCoordFromEvent(e);if(dispatchEvent(e)){return preventDefault(e)}return true}function onPointerEvent(e){updateCoordFromEvent(e);if(dispatchEvent(e)){return preventDefault(e)}var keycode=obj.mouse.bind[e.button||0];if(keycode){if(e.type===activeEventList[2]){return keydown(e,keycode)}else{return keyup(e,keycode)}}return true}function onDeviceMotion(e){obj.accel=e.accelerationIncludingGravity}obj.accel={x:0,y:0,z:0};obj.mouse={pos:null,LEFT:0,MIDDLE:1,RIGHT:2,bind:[0,0,0]};obj.offset=null;obj.throttlingInterval=undefined;obj.changedTouches=[];obj.KEY={LEFT:37,UP:38,RIGHT:39,DOWN:40,ENTER:13,SHIFT:16,CTRL:17,ALT:18,PAUSE:19,ESC:27,SPACE:32,NUM0:48,NUM1:49,NUM2:50,NUM3:51,NUM4:52,NUM5:53,NUM6:54,NUM7:55,NUM8:56,NUM9:57,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90};obj.isKeyPressed=function(action){if(keyStatus[action]){if(keyLock[action]){keyLocked[action]=true;keyStatus[action]=false}return true}return false};obj.keyStatus=function(action){return(keyLocked[action]===true)?true:keyStatus[action]};obj.triggerKeyEvent=function(keycode,status){if(status){keydown({},keycode)}else{keyup({},keycode)}};obj.bindKey=function(keycode,action,lock){enableKeyboardEvent();KeyBinding[keycode]=action;keyStatus[action]=false;keyLock[action]=lock?lock:false;keyLocked[action]=false};obj.unlockKey=function(action){keyLocked[action]=false};obj.unbindKey=function(keycode){keyStatus[KeyBinding[keycode]]=false;keyLock[KeyBinding[keycode]]=false;KeyBinding[keycode]=null};obj.globalToLocal=function(x,y){var offset=obj.offset;x-=offset.left;y-=offset.top;var scale=me.sys.scale;if(scale.x!=1||scale.y!=1){x/=scale.x;y/=scale.y}return new me.Vector2d(x,y)};obj.bindMouse=function(button,keyCode){enablePointerEvent();if(!KeyBinding[keyCode]){throw"melonJS : no action defined for keycode "+keyCode}obj.mouse.bind[button]=keyCode};obj.unbindMouse=function(button){obj.mouse.bind[button]=null};obj.bindTouch=function(keyCode){obj.bindMouse(me.input.mouse.LEFT,keyCode)};obj.unbindTouch=function(){obj.unbindMouse(me.input.mouse.LEFT)};obj.registerPointerEvent=function(eventType,rect,callback,floating){enablePointerEvent();if((mouseEventList.indexOf(eventType)!==-1)&&(me.sys.touch||window.navigator.pointerEnabled)){eventType=activeEventList[mouseEventList.indexOf(eventType)]}if(eventType&&(activeEventList.indexOf(eventType)!==-1)){if(!evtHandlers[eventType]){evtHandlers[eventType]=[]}var _float=rect.floating===true?true:false;if(floating){_float=floating===true?true:false}evtHandlers[eventType].push({rect:rect||null,cb:callback,floating:_float});return}throw"melonJS : invalid event type : "+eventType};obj.releasePointerEvent=function(eventType,rect){if((mouseEventList.indexOf(eventType)!==-1)&&(me.sys.touch||window.navigator.pointerEnabled)){eventType=activeEventList[mouseEventList.indexOf(eventType)]}if(eventType&&(activeEventList.indexOf(eventType)!==-1)){if(!evtHandlers[eventType]){evtHandlers[eventType]=[]}var handlers=evtHandlers[eventType];if(handlers){for(var i=handlers.length,handler;i--,handler=handlers[i];){if(handler.rect===rect){handler.rect=handler.cb=handler.floating=null;evtHandlers[eventType].splice(i,1)}}}return}throw"melonJS : invalid event type : "+eventType};obj.watchAccelerometer=function(){if(window.sys.gyro){if(!accelInitialized){window.addEventListener("devicemotion",onDeviceMotion,false);accelInitialized=true}return true}return false};obj.unwatchAccelerometer=function(){if(accelInitialized){window.removeEventListener("devicemotion",onDeviceMotion,false);accelInitialized=false}};return obj})()})(window);(function($){var Base64=(function(){var singleton={};var _keyStr="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";singleton.decode=function(input){input=input.replace(/[^A-Za-z0-9\+\/\=]/g,"");if(me.sys.nativeBase64){return $.atob(input)}else{var output=[],chr1,chr2,chr3,enc1,enc2,enc3,enc4,i=0;while(i<input.length){enc1=_keyStr.indexOf(input.charAt(i++));enc2=_keyStr.indexOf(input.charAt(i++));enc3=_keyStr.indexOf(input.charAt(i++));enc4=_keyStr.indexOf(input.charAt(i++));chr1=(enc1<<2)|(enc2>>4);chr2=((enc2&15)<<4)|(enc3>>2);chr3=((enc3&3)<<6)|enc4;output.push(String.fromCharCode(chr1));if(enc3!=64){output.push(String.fromCharCode(chr2))}if(enc4!=64){output.push(String.fromCharCode(chr3))}}output=output.join("");return output}};return singleton})();me.utils=(function(){var api={};var rgbCache={};var GUID_base="";var GUID_index=0;var removepath=/^.*(\\|\/|\:)/;var removeext=/\.[^\.]*$/;api.decodeBase64=function(input){return Base64.decode(input)};api.decodeBase64AsArray=function(input,bytes){bytes=bytes||1;var dec=Base64.decode(input),i,j,len;if(typeof window.Uint32Array==="function"){var ar=new Uint32Array(dec.length/bytes)}else{var ar=[]}for(i=0,len=dec.length/bytes;i<len;i++){ar[i]=0;for(j=bytes-1;j>=0;--j){ar[i]+=dec.charCodeAt((i*bytes)+j)<<(j<<3)}}return ar};api.decompress=function(data,format){throw"melonJS: GZIP/ZLIB compressed TMX Tile Map not supported!"};api.decodeCSV=function(input,limit){input=input.trim().split("\n");var result=[];for(var i=0;i<input.length;i++){entries=input[i].split(",",limit);for(var e=0;e<entries.length;e++){result.push(+entries[e])}}return result};api.getBasename=function(path){return path.replace(removepath,"").replace(removeext,"")};api.getFileExtension=function(path){return path.substring(path.lastIndexOf(".")+1,path.length)};api.setNocache=function(enable){me.nocache=enable?"?"+parseInt(Math.random()*10000000):""};api.HexToRGB=function(h,a){if(h.charAt(0)!=="#"){return h}h=h.substring(1,h.length);if(rgbCache[h]==null){if(h.length<6){var h1=h.charAt(0)+h.charAt(0);var h2=h.charAt(1)+h.charAt(1);var h3=h.charAt(2)+h.charAt(2)}else{var h1=h.substring(0,2);var h2=h.substring(2,4);var h3=h.substring(4,6)}rgbCache[h]=parseInt(h1,16)+","+parseInt(h2,16)+","+parseInt(h3,16)}return(a?"rgba(":"rgb(")+rgbCache[h]+(a?","+a+")":")")};api.RGBToHex=function(r,g,b){return r.toHex()+g.toHex()+b.toHex()};api.getPixels=function(arg){if(arg instanceof HTMLImageElement){var c=me.video.createCanvasSurface(arg.width,arg.height);c.drawImage(arg,0,0);return c.getImageData(0,0,arg.width,arg.height)}else{return arg.getContext("2d").getImageData(0,0,arg.width,arg.height)}};api.resetGUID=function(base){GUID_base=base.toString().toUpperCase().toHex();GUID_index=0};api.createGUID=function(){return GUID_base+"-"+(GUID_index++)};api.applyFriction=function(v,f){return(v+f<0)?v+(f*me.timer.tick):(v-f>0)?v-(f*me.timer.tick):0};return api})()})(window);(function($){function Stat_Item(val){this.defaultvalue=val||0;this.value=val||0;this.updated=true}Stat_Item.prototype.reset=function(){this.set(this.defaultvalue)};Stat_Item.prototype.update=function(val){return this.set(this.value+val)};Stat_Item.prototype.set=function(value){this.value=value;this.updated=true;return this.updated};me.gamestat=(function(){var singleton={};var items={};var obj=[];var objCount=0;singleton.add=function(name,val){var addStat=function(k,v){items[k]=new Stat_Item(v);obj.push(items[k]);objCount++};if(name.constructor===Object){for(var key in name){addStat(key,name[key])}}else{addStat(name,val)}};singleton.updateValue=function(name,value){var updateStat=function(k,v){items[k].update(v)};if(name.constructor===Object){for(var key in name){if(items[key]){updateStat(key,name[key])}}}else{if(items[name]){updateStat(name,value)}}};singleton.setValue=function(name,value){var setStat=function(k,v){items[k].set(v)};if(name.constructor===Object){for(var key in name){if(items[key]){setStat(key,name[key])}}}else{if(items[name]){setStat(name,value)}}};singleton.getItemValue=function(name){return(items[name])?items[name].value:0};singleton.reset=function(name){if(name!=undefined){if(items[name]){items[name].reset()}}else{singleton.resetAll()}};singleton.resetAll=function(){for(var i=objCount,objt;i--,objt=obj[i];){objt.reset()}};return singleton})()})(window);(function($){me.COLLISION_LAYER="collision";me.TMX_TAG_MAP="map";me.TMX_TAG_NAME="name";me.TMX_TAG_VALUE="value";me.TMX_TAG_VERSION="version";me.TMX_TAG_ORIENTATION="orientation";me.TMX_TAG_WIDTH="width";me.TMX_TAG_HEIGHT="height";me.TMX_TAG_OPACITY="opacity";me.TMX_TAG_TRANS="trans";me.TMX_TAG_TILEWIDTH="tilewidth";me.TMX_TAG_TILEHEIGHT="tileheight";me.TMX_TAG_TILEOFFSET="tileoffset";me.TMX_TAG_FIRSTGID="firstgid";me.TMX_TAG_GID="gid";me.TMX_TAG_TILE="tile";me.TMX_TAG_ID="id";me.TMX_TAG_DATA="data";me.TMX_TAG_COMPRESSION="compression";me.TMX_TAG_GZIP="gzip";me.TMX_TAG_ZLIB="zlib";me.TMX_TAG_ENCODING="encoding";me.TMX_TAG_ATTR_BASE64="base64";me.TMX_TAG_CSV="csv";me.TMX_TAG_SPACING="spacing";me.TMX_TAG_MARGIN="margin";me.TMX_TAG_PROPERTIES="properties";me.TMX_TAG_PROPERTY="property";me.TMX_TAG_IMAGE="image";me.TMX_TAG_SOURCE="source";me.TMX_TAG_VISIBLE="visible";me.TMX_TAG_TILESET="tileset";me.TMX_TAG_LAYER="layer";me.TMX_TAG_TILE_LAYER="tilelayer";me.TMX_TAG_IMAGE_LAYER="imagelayer";me.TMX_TAG_OBJECTGROUP="objectgroup";me.TMX_TAG_OBJECT="object";me.TMX_TAG_X="x";me.TMX_TAG_Y="y";me.TMX_TAG_WIDTH="width";me.TMX_TAG_HEIGHT="height";me.TMX_TAG_POLYGON="polygon";me.TMX_TAG_POLYLINE="polyline";me.TMX_TAG_POINTS="points";me.TMX_BACKGROUND_COLOR="backgroundcolor"})(window);(function($){me.TMXUtils=(function(){function setTMXValue(value){if(!value||value.isBoolean()){value=value?(value==="true"):true}else{if(value.isNumeric()){value=Number(value)}else{if(value.match(/^json:/i)){var match=value.split(/^json:/i)[1];try{value=JSON.parse(match)}catch(e){throw"Unable to parse JSON: "+match}}}}return value}var api={};api.applyTMXPropertiesFromXML=function(obj,xmldata){var properties=xmldata.getElementsByTagName(me.TMX_TAG_PROPERTIES)[0];if(properties){var oProp=properties.getElementsByTagName(me.TMX_TAG_PROPERTY);for(var i=0;i<oProp.length;i++){var propname=me.mapReader.TMXParser.getStringAttribute(oProp[i],me.TMX_TAG_NAME);var value=me.mapReader.TMXParser.getStringAttribute(oProp[i],me.TMX_TAG_VALUE);obj[propname]=setTMXValue(value)}}};api.applyTMXPropertiesFromJSON=function(obj,data){var properties=data[me.TMX_TAG_PROPERTIES];if(properties){for(var name in properties){if(properties.hasOwnProperty(name)){obj[name]=setTMXValue(properties[name])}}}};api.mergeProperties=function(dest,src,overwrite){for(var p in src){if(overwrite||dest[p]===undefined){dest[p]=src[p]}}return dest};return api})()})(window);(function($){me.TMXOBjectGroup=Object.extend({initFromXML:function(name,tmxObjGroup,tilesets,z){this.name=name;this.width=me.mapReader.TMXParser.getIntAttribute(tmxObjGroup,me.TMX_TAG_WIDTH);this.height=me.mapReader.TMXParser.getIntAttribute(tmxObjGroup,me.TMX_TAG_HEIGHT);this.visible=(me.mapReader.TMXParser.getIntAttribute(tmxObjGroup,me.TMX_TAG_VISIBLE,1)==1);this.z=z;this.objects=[];if(tmxObjGroup.firstChild&&(tmxObjGroup.firstChild.nextSibling.nodeName===me.TMX_TAG_PROPERTIES)){me.TMXUtils.applyTMXPropertiesFromXML(this,tmxObjGroup)}var data=tmxObjGroup.getElementsByTagName(me.TMX_TAG_OBJECT);for(var i=0;i<data.length;i++){var object=new me.TMXOBject();object.initFromXML(data[i],tilesets,z);this.objects.push(object)}},initFromJSON:function(name,tmxObjGroup,tilesets,z){var self=this;this.name=name;this.width=tmxObjGroup[me.TMX_TAG_WIDTH];this.height=tmxObjGroup[me.TMX_TAG_HEIGHT];this.visible=tmxObjGroup[me.TMX_TAG_VISIBLE];this.z=z;this.objects=[];me.TMXUtils.applyTMXPropertiesFromJSON(this,tmxObjGroup);tmxObjGroup.objects.forEach(function(tmxObj){var object=new me.TMXOBject();object.initFromJSON(tmxObj,tilesets,z);self.objects.push(object)})},reset:function(){this.objects=null},getObjectCount:function(){return this.objects.length},getObjectByIndex:function(idx){return this.objects[idx]}});me.TMXOBject=Object.extend({initFromXML:function(tmxObj,tilesets,z){this.name=me.mapReader.TMXParser.getStringAttribute(tmxObj,me.TMX_TAG_NAME);this.x=me.mapReader.TMXParser.getIntAttribute(tmxObj,me.TMX_TAG_X);this.y=me.mapReader.TMXParser.getIntAttribute(tmxObj,me.TMX_TAG_Y);this.z=z;this.width=me.mapReader.TMXParser.getIntAttribute(tmxObj,me.TMX_TAG_WIDTH,0);this.height=me.mapReader.TMXParser.getIntAttribute(tmxObj,me.TMX_TAG_HEIGHT,0);this.gid=me.mapReader.TMXParser.getIntAttribute(tmxObj,me.TMX_TAG_GID,null);if(this.gid){this.setImage(this.gid,tilesets)}else{var polygon=tmxObj.getElementsByTagName(me.TMX_TAG_POLYGON);this.isPolygon=true;if(!polygon.length){polygon=tmxObj.getElementsByTagName(me.TMX_TAG_POLYLINE);this.isPolygon=false}if(polygon.length){this.points=[];var points=me.mapReader.TMXParser.getStringAttribute(polygon[0],me.TMX_TAG_POINTS);var point=points.split(" ");for(var i=0,v;i<point.length;i++){v=point[i].split(",");this.points[i]=new me.Vector2d(+v[0],+v[1])}}}me.game.renderer.adjustPosition(this);me.TMXUtils.applyTMXPropertiesFromXML(this,tmxObj)},initFromJSON:function(tmxObj,tilesets,z){this.name=tmxObj[me.TMX_TAG_NAME];this.x=parseInt(tmxObj[me.TMX_TAG_X]);this.y=parseInt(tmxObj[me.TMX_TAG_Y]);this.z=parseInt(z);this.width=parseInt(tmxObj[me.TMX_TAG_WIDTH]||0);this.height=parseInt(tmxObj[me.TMX_TAG_HEIGHT]||0);this.gid=parseInt(tmxObj[me.TMX_TAG_GID])||null;if(this.gid){this.setImage(this.gid,tilesets)}else{var polygon=tmxObj[me.TMX_TAG_POLYGON];this.isPolygon=polygon!==undefined;if(!polygon){polygon=tmxObj[me.TMX_TAG_POLYLINE];this.isPolygon=false}if(polygon){this.points=[];var self=this;var i=0;polygon.forEach(function(point){self.points[i++]=new me.Vector2d(parseInt(point.x),parseInt(point.y))})}}me.game.renderer.adjustPosition(this);me.TMXUtils.applyTMXPropertiesFromJSON(this,tmxObj)},setImage:function(gid,tilesets){var tileset=tilesets.getTilesetByGid(this.gid);this.width=tileset.tilewidth;this.height=tileset.tileheight;this.spritewidth=this.width;var tmxTile=new me.Tile(this.x,this.y,tileset.tilewidth,tileset.tileheight,this.gid);this.image=tileset.getTileImage(tmxTile)},getObjectPropertyByName:function(name){return this[name]}})})(window);(function($){var FlippedHorizontallyFlag=2147483648;var FlippedVerticallyFlag=1073741824;var FlippedAntiDiagonallyFlag=536870912;me.Tile=me.Rect.extend({tileId:null,init:function(x,y,w,h,gid){this.parent(new me.Vector2d(x*w,y*h),w,h);this.col=x;this.row=y;this.tileId=gid;this.flipX=(this.tileId&FlippedHorizontallyFlag)!==0;this.flipY=(this.tileId&FlippedVerticallyFlag)!==0;this.flipAD=(this.tileId&FlippedAntiDiagonallyFlag)!==0;this.flipped=this.flipX||this.flipY||this.flipAD;this.tileId&=~(FlippedHorizontallyFlag|FlippedVerticallyFlag|FlippedAntiDiagonallyFlag)}});me.TMXTileset=Object.extend({type:{SOLID:"solid",PLATFORM:"platform",L_SLOPE:"lslope",R_SLOPE:"rslope",LADDER:"ladder",TOPLADDER:"topladder",BREAKABLE:"breakable"},init:function(){this.TileProperties=[];this.tileXOffset=[];this.tileYOffset=[]},initFromXML:function(xmltileset){this.firstgid=me.mapReader.TMXParser.getIntAttribute(xmltileset,me.TMX_TAG_FIRSTGID);var src=me.mapReader.TMXParser.getStringAttribute(xmltileset,me.TMX_TAG_SOURCE);if(src){src=me.utils.getBasename(src);xmltileset=me.loader.getTMX(src);if(!xmltileset){throw"melonJS:"+src+" TSX tileset not found"}me.mapReader.TMXParser.parseFromString(xmltileset);xmltileset=me.mapReader.TMXParser.getFirstElementByTagName("tileset")}this.name=me.mapReader.TMXParser.getStringAttribute(xmltileset,me.TMX_TAG_NAME);this.tilewidth=me.mapReader.TMXParser.getIntAttribute(xmltileset,me.TMX_TAG_TILEWIDTH);this.tileheight=me.mapReader.TMXParser.getIntAttribute(xmltileset,me.TMX_TAG_TILEHEIGHT);this.spacing=me.mapReader.TMXParser.getIntAttribute(xmltileset,me.TMX_TAG_SPACING,0);this.margin=me.mapReader.TMXParser.getIntAttribute(xmltileset,me.TMX_TAG_MARGIN,0);this.tileoffset=new me.Vector2d(0,0);var offset=xmltileset.getElementsByTagName(me.TMX_TAG_TILEOFFSET);if(offset.length>0){this.tileoffset.x=me.mapReader.TMXParser.getIntAttribute(offset[0],me.TMX_TAG_X);this.tileoffset.y=me.mapReader.TMXParser.getIntAttribute(offset[0],me.TMX_TAG_Y)}var tileInfo=xmltileset.getElementsByTagName(me.TMX_TAG_TILE);for(var i=0;i<tileInfo.length;i++){var tileID=me.mapReader.TMXParser.getIntAttribute(tileInfo[i],me.TMX_TAG_ID)+this.firstgid;var prop={};me.TMXUtils.applyTMXPropertiesFromXML(prop,tileInfo[i]);this.setTileProperty(tileID,prop)}var imagesrc=xmltileset.getElementsByTagName(me.TMX_TAG_IMAGE)[0].getAttribute(me.TMX_TAG_SOURCE);var image=(imagesrc)?me.loader.getImage(me.utils.getBasename(imagesrc)):null;if(!image){console.log("melonJS: '"+imagesrc+"' file for tileset '"+this.name+"' not found!")}var trans=xmltileset.getElementsByTagName(me.TMX_TAG_IMAGE)[0].getAttribute(me.TMX_TAG_TRANS);this.initFromImage(image,trans)},initFromJSON:function(tileset){this.firstgid=tileset[me.TMX_TAG_FIRSTGID];var src=tileset[me.TMX_TAG_SOURCE];if(src){src=me.utils.getBasename(src);var tileset=me.loader.getTMX(src);if(!tileset){throw"melonJS:"+src+" TSX tileset not found"}}this.name=tileset[me.TMX_TAG_NAME];this.tilewidth=parseInt(tileset[me.TMX_TAG_TILEWIDTH]);this.tileheight=parseInt(tileset[me.TMX_TAG_TILEHEIGHT]);this.spacing=parseInt(tileset[me.TMX_TAG_SPACING]||0);this.margin=parseInt(tileset[me.TMX_TAG_MARGIN]||0);this.tileoffset=new me.Vector2d(0,0);var offset=tileset[me.TMX_TAG_TILEOFFSET];if(offset){this.tileoffset.x=parseInt(offset[me.TMX_TAG_X]);this.tileoffset.y=parseInt(offset[me.TMX_TAG_Y])}var tileInfo=tileset.tileproperties;for(var i in tileInfo){var prop={};me.TMXUtils.mergeProperties(prop,tileInfo[i]);this.setTileProperty(parseInt(i)+this.firstgid,prop)}var imagesrc=me.utils.getBasename(tileset[me.TMX_TAG_IMAGE]);var image=imagesrc?me.loader.getImage(imagesrc):null;if(!image){console.log("melonJS: '"+imagesrc+"' file for tileset '"+this.name+"' not found!")}var trans=tileset[me.TMX_TAG_TRANS]||null;this.initFromImage(image,trans)},initFromImage:function(image,transparency){if(image){this.image=image;this.hTileCount=~~((this.image.width-this.margin)/(this.tilewidth+this.spacing));this.vTileCount=~~((this.image.height-this.margin)/(this.tileheight+this.spacing))}this.lastgid=this.firstgid+(((this.hTileCount*this.vTileCount)-1)||0);if(transparency!==null&&this.image){this.image=me.video.applyRGBFilter(this.image,"transparent",transparency.toUpperCase()).canvas}},setTileProperty:function(gid,prop){prop.isSolid=prop.type?prop.type.toLowerCase()===this.type.SOLID:false;prop.isPlatform=prop.type?prop.type.toLowerCase()===this.type.PLATFORM:false;prop.isLeftSlope=prop.type?prop.type.toLowerCase()===this.type.L_SLOPE:false;prop.isRightSlope=prop.type?prop.type.toLowerCase()===this.type.R_SLOPE:false;prop.isBreakable=prop.type?prop.type.toLowerCase()===this.type.BREAKABLE:false;prop.isLadder=prop.type?prop.type.toLowerCase()===this.type.LADDER:false;prop.isTopLadder=prop.type?prop.type.toLowerCase()===this.type.TOPLADDER:false;prop.isSlope=prop.isLeftSlope||prop.isRightSlope;prop.isCollidable=!!(prop.type);this.TileProperties[gid]=prop},contains:function(gid){return(gid>=this.firstgid&&gid<=this.lastgid)},getTileImage:function(tmxTile){var image=me.video.createCanvasSurface(this.tilewidth,this.tileheight);this.drawTile(image,0,0,tmxTile);return image.canvas},getTileProperties:function(tileId){return this.TileProperties[tileId]},isTileCollidable:function(tileId){return this.TileProperties[tileId].isCollidable},getTileOffsetX:function(tileId){if(this.tileXOffset[tileId]==null){this.tileXOffset[tileId]=this.margin+(this.spacing+this.tilewidth)*(tileId%this.hTileCount)}return this.tileXOffset[tileId]},getTileOffsetY:function(tileId){if(this.tileYOffset[tileId]==null){this.tileYOffset[tileId]=this.margin+(this.spacing+this.tileheight)*~~(tileId/this.hTileCount)}return this.tileYOffset[tileId]},drawTile:function(context,dx,dy,tmxTile){if(tmxTile.flipped){var m11=1;var m12=0;var m21=0;var m22=1;var mx=dx;var my=dy;dx=dy=0;context.save();if(tmxTile.flipAD){m11=0;m12=1;m21=1;m22=0;my+=this.tileheight-this.tilewidth}if(tmxTile.flipX){m11=-m11;m21=-m21;mx+=tmxTile.flipAD?this.tileheight:this.tilewidth}if(tmxTile.flipY){m12=-m12;m22=-m22;my+=tmxTile.flipAD?this.tilewidth:this.tileheight}context.transform(m11,m12,m21,m22,mx,my)}var tileid=tmxTile.tileId-this.firstgid;context.drawImage(this.image,this.getTileOffsetX(tileid),this.getTileOffsetY(tileid),this.tilewidth,this.tileheight,dx,dy,this.tilewidth,this.tileheight);if(tmxTile.flipped){context.restore()}}});me.TMXTilesetGroup=Object.extend({init:function(){this.tilesets=[]},add:function(tileset){this.tilesets.push(tileset)},getTilesetByIndex:function(i){return this.tilesets[i]},getTilesetByGid:function(gid){var invalidRange=-1;for(var i=0,len=this.tilesets.length;i<len;i++){if(this.tilesets[i].contains(gid)){return this.tilesets[i]}if(this.tilesets[i].firstgid==this.tilesets[i].lastgid){if(gid>=this.tilesets[i].firstgid){invalidRange=i}}}if(invalidRange!=-1){return this.tilesets[invalidRange]}else{throw"no matching tileset found for gid "+gid}}})})(window);(function($){me.TMXOrthogonalRenderer=Object.extend({init:function(cols,rows,tilewidth,tileheight){this.cols=cols;this.rows=rows;this.tilewidth=tilewidth;this.tileheight=tileheight},canRender:function(layer){return((layer.orientation==="orthogonal")&&(this.cols===layer.cols)&&(this.rows===layer.rows)&&(this.tilewidth===layer.tilewidth)&&(this.tileheight===layer.tileheight))},pixelToTileCoords:function(x,y){return new me.Vector2d(x/this.tilewidth,y/this.tileheight)},tileToPixelCoords:function(x,y){return new me.Vector2d(x*this.tilewidth,y*this.tileheight)},adjustPosition:function(obj){if(typeof(obj.gid)==="number"){obj.y-=obj.height}},drawTile:function(context,x,y,tmxTile,tileset){tileset.drawTile(context,tileset.tileoffset.x+x*this.tilewidth,tileset.tileoffset.y+(y+1)*this.tileheight-tileset.tileheight,tmxTile)},drawTileLayer:function(context,layer,viewport,rect){var start=this.pixelToTileCoords(viewport.x+rect.pos.x,viewport.y+rect.pos.y).floorSelf();var end=this.pixelToTileCoords(viewport.x+rect.pos.x+rect.width+this.tilewidth,viewport.y+rect.pos.y+rect.height+this.tileheight).ceilSelf();end.x=end.x>this.cols?this.cols:end.x;end.y=end.y>this.rows?this.rows:end.y;for(var y=start.y;y<end.y;y++){for(var x=start.x;x<end.x;x++){var tmxTile=layer.layerData[x][y];if(tmxTile){if(!layer.tileset.contains(tmxTile.tileId)){layer.tileset=layer.tilesets.getTilesetByGid(tmxTile.tileId)}this.drawTile(context,x,y,tmxTile,layer.tileset)}}}}});me.TMXIsometricRenderer=Object.extend({init:function(cols,rows,tilewidth,tileheight){this.cols=cols;this.rows=rows;this.tilewidth=tilewidth;this.tileheight=tileheight;this.hTilewidth=tilewidth/2;this.hTileheight=tileheight/2;this.originX=this.rows*this.hTilewidth},canRender:function(layer){return((layer.orientation==="isometric")&&(this.cols===layer.cols)&&(this.rows===layer.rows)&&(this.tilewidth===layer.tilewidth)&&(this.tileheight===layer.tileheight))},pixelToTileCoords:function(x,y){x-=this.originX;var tileY=y/this.tileheight;var tileX=x/this.tilewidth;return new me.Vector2d(tileY+tileX,tileY-tileX)},tileToPixelCoords:function(x,y){return new me.Vector2d((x-y)*this.hTilewidth+this.originX,(x+y)*this.hTileheight)},adjustPosition:function(obj){var tilex=obj.x/this.hTilewidth;var tiley=obj.y/this.tileheight;var isoPos=this.tileToPixelCoords(tilex,tiley);isoPos.x-=obj.width/2;isoPos.y-=obj.height;obj.x=isoPos.x;obj.y=isoPos.y},drawTile:function(context,x,y,tmxTile,tileset){tileset.drawTile(context,((this.cols-1)*tileset.tilewidth+(x-y)*tileset.tilewidth>>1),(-tileset.tilewidth+(x+y)*tileset.tileheight>>2),tmxTile)},drawTileLayer:function(context,layer,viewport,rect){var tileset=layer.tileset;var offset=tileset.tileoffset;var rowItr=this.pixelToTileCoords(viewport.x+rect.pos.x-tileset.tilewidth,viewport.y+rect.pos.y-tileset.tileheight).floorSelf();var TileEnd=this.pixelToTileCoords(viewport.x+rect.pos.x+rect.width+tileset.tilewidth,viewport.y+rect.pos.y+rect.height+tileset.tileheight).ceilSelf();var rectEnd=this.tileToPixelCoords(TileEnd.x,TileEnd.y);var startPos=this.tileToPixelCoords(rowItr.x,rowItr.y);startPos.x-=this.hTilewidth;startPos.y+=this.tileheight;var inUpperHalf=startPos.y-rect.pos.y+viewport.y>this.hTileheight;var inLeftHalf=rect.pos.x+viewport.x-startPos.x<this.hTilewidth;if(inUpperHalf){if(inLeftHalf){rowItr.x--;startPos.x-=this.hTilewidth}else{rowItr.y--;startPos.x+=this.hTilewidth}startPos.y-=this.hTileheight}var shifted=inUpperHalf^inLeftHalf;var columnItr=rowItr.clone();for(var y=startPos.y;y-this.tileheight<rectEnd.y;y+=this.hTileheight){columnItr.setV(rowItr);for(var x=startPos.x;x<rectEnd.x;x+=this.tilewidth){if((columnItr.x>=0)&&(columnItr.y>=0)&&(columnItr.x<this.cols)&&(columnItr.y<this.rows)){var tmxTile=layer.layerData[columnItr.x][columnItr.y];if(tmxTile){if(!tileset.contains(tmxTile.tileId)){tileset=layer.tileset=layer.tilesets.getTilesetByGid(tmxTile.tileId);offset=tileset.tileoffset}tileset.drawTile(context,offset.x+x,offset.y+y-tileset.tileheight,tmxTile)}}columnItr.x++;columnItr.y--}if(!shifted){rowItr.x++;startPos.x+=this.hTilewidth;shifted=true}else{rowItr.y++;startPos.x-=this.hTilewidth;shifted=false}}}})})(window);(function(window){me.ColorLayer=me.Renderable.extend({init:function(name,color,z){this.name=name;this.color=me.utils.HexToRGB(color);this.z=z;this.opacity=1;this.floating=true;this.parent(new me.Vector2d(0,0),me.game.viewport.width,me.game.viewport.height)},reset:function(){},getOpacity:function(){return this.opacity},setOpacity:function(alpha){if(typeof(alpha)==="number"){this.opacity=alpha.clamp(0,1)}},update:function(){return false},draw:function(context,rect){var _alpha=context.globalAlpha;context.globalAlpha=this.opacity;context.fillStyle=this.color;context.fillRect(rect.left,rect.top,rect.width,rect.height);context.globalAlpha=_alpha}});me.ImageLayer=me.Renderable.extend({ratio:new me.Vector2d(1,1),init:function(name,width,height,imagesrc,z,ratio){this.name=name;this.image=(imagesrc)?me.loader.getImage(me.utils.getBasename(imagesrc)):null;if(!this.image){throw"melonJS: '"+imagesrc+"' file for Image Layer '"+this.name+"' not found!"}this.imagewidth=this.image.width;this.imageheight=this.image.height;this.z=z;this.ratio.set(1,1);if(ratio){if(typeof(ratio)==="number"){this.ratio.set(ratio,ratio)}else{this.ratio.setV(ratio)}}this.viewport=me.game.viewport;this.lastpos=this.viewport.pos.clone();width=width?Math.min(this.viewport.width,width):this.viewport.width;height=height?Math.min(this.viewport.height,height):this.viewport.height;this.parent(new me.Vector2d(0,0),width,height);this.opacity=1;this.floating=true;this._repeat="repeat";this.repeatX=true;this.repeatY=true;Object.defineProperty(this,"repeat",{get:function get(){return this._repeat},set:function set(val){this._repeat=val;switch(this._repeat){case"no-repeat":this.repeatX=false;this.repeatY=false;break;case"repeat-x":this.repeatX=true;this.repeatY=false;break;case"repeat-y":this.repeatX=false;this.repeatY=true;break;default:this.repeatX=true;this.repeatY=true;break}}});this.anchorPoint.set(0,0)},reset:function(){this.image=null;this.lastpos=null;this.viewport=null},getOpacity:function(){return this.opacity},setOpacity:function(alpha){if(typeof(alpha)==="number"){this.opacity=alpha.clamp(0,1)}},update:function(){if(0===this.ratio.x&&0===this.ratio.y){return false}else{var vpos=this.viewport.pos;if(!this.lastpos.equals(vpos)){this.pos.x+=((vpos.x-this.lastpos.x)*this.ratio.x)%this.imagewidth;this.pos.x=(this.imagewidth+this.pos.x)%this.imagewidth;this.pos.y+=((vpos.y-this.lastpos.y)*this.ratio.y)%this.imageheight;this.pos.y=(this.imageheight+this.pos.y)%this.imageheight;this.lastpos.setV(vpos);return true}return false}},draw:function(context,rect){context.save();if(this.anchorPoint.y!==0||this.anchorPoint.x!==0){context.translate(~~(this.anchorPoint.x*(this.viewport.width-this.imagewidth)),~~(this.anchorPoint.y*(this.viewport.height-this.imageheight)))}context.globalAlpha=this.opacity;if(0===this.ratio.x&&0===this.ratio.y){var sw=Math.min(rect.width,this.imagewidth);var sh=Math.min(rect.height,this.imageheight);context.drawImage(this.image,rect.left,rect.top,sw,sh,rect.left,rect.top,sw,sh)}else{var sx=~~this.pos.x;var sy=~~this.pos.y;var dx=0;var dy=0;var sw=Math.min(this.imagewidth-sx,this.width);var sh=Math.min(this.imageheight-sy,this.height);do{do{context.drawImage(this.image,sx,sy,sw,sh,dx,dy,sw,sh);sy=0;dy+=sh;sh=Math.min(this.imageheight,this.height-dy)}while(this.repeatY&&(dy<this.height));dx+=sw;if(!this.repeatX||(dx>=this.width)){break}sx=0;sw=Math.min(this.imagewidth,this.width-dx);sy=~~this.pos.y;dy=0;sh=Math.min(this.imageheight-~~this.pos.y,this.height)}while(true)}context.restore()}});me.CollisionTiledLayer=me.Renderable.extend({init:function(width,height){this.parent(new me.Vector2d(0,0),width,height);this.isCollisionMap=true},reset:function(){},checkCollision:function(obj,pv){var x=(pv.x<0)?obj.left+pv.x:obj.right+pv.x;var y=(pv.y<0)?obj.top+pv.y:obj.bottom+pv.y;var res={x:0,y:0,xprop:{},yprop:{}};if(x<=0||x>=this.width){res.x=pv.x}if(y<=0||y>=this.height){res.y=pv.y}return res}});me.TMXLayer=me.Renderable.extend({layerData:null,init:function(tilewidth,tileheight,orientation,tilesets,zOrder){this.tilewidth=tilewidth;this.tileheight=tileheight;this.orientation=orientation;this.z=zOrder;this.tilesets=tilesets;this.tileset=this.tilesets?this.tilesets.getTilesetByIndex(0):null;this.parent(new me.Vector2d(0,0),0,0)},initFromXML:function(layer){this.name=me.mapReader.TMXParser.getStringAttribute(layer,me.TMX_TAG_NAME);this.visible=(me.mapReader.TMXParser.getIntAttribute(layer,me.TMX_TAG_VISIBLE,1)==1);this.opacity=me.mapReader.TMXParser.getFloatAttribute(layer,me.TMX_TAG_OPACITY,1).clamp(0,1);this.cols=me.mapReader.TMXParser.getIntAttribute(layer,me.TMX_TAG_WIDTH);this.rows=me.mapReader.TMXParser.getIntAttribute(layer,me.TMX_TAG_HEIGHT);this.width=this.cols*this.tilewidth;this.height=this.rows*this.tileheight;me.TMXUtils.applyTMXPropertiesFromXML(this,layer);if(this.preRender===undefined){this.preRender=me.sys.preRender}this.isCollisionMap=(this.name.toLowerCase().contains(me.COLLISION_LAYER));if(this.isCollisionMap&&!me.debug.renderCollisionMap){this.visible=false}if(this.preRender){this.layerCanvas=me.video.createCanvas(this.cols*this.tilewidth,this.rows*this.tileheight);this.layerSurface=this.layerCanvas.getContext("2d");me.video.setImageSmoothing(this.layerSurface,me.sys.scalingInterpolation);this.layerSurface.globalAlpha=this.opacity}},initFromJSON:function(layer){this.name=layer[me.TMX_TAG_NAME];this.visible=layer[me.TMX_TAG_VISIBLE];this.opacity=parseFloat(layer[me.TMX_TAG_OPACITY]).clamp(0,1);this.cols=parseInt(layer[me.TMX_TAG_WIDTH]);this.rows=parseInt(layer[me.TMX_TAG_HEIGHT]);this.width=this.cols*this.tilewidth;this.height=this.rows*this.tileheight;me.TMXUtils.applyTMXPropertiesFromJSON(this,layer);if(this.preRender===undefined){this.preRender=me.sys.preRender}this.isCollisionMap=(this.name.toLowerCase().contains(me.COLLISION_LAYER));if(this.isCollisionMap&&!me.debug.renderCollisionMap){this.visible=false}if(this.preRender){this.layerCanvas=me.video.createCanvas(this.cols*this.tilewidth,this.rows*this.tileheight);this.layerSurface=this.layerCanvas.getContext("2d");me.video.setImageSmoothing(this.layerSurface,me.sys.scalingInterpolation);this.layerSurface.globalAlpha=this.opacity}},reset:function(){if(this.preRender){this.layerCanvas=null;this.layerSurface=null}this.renderer=null;this.layerData=null;this.tileset=null;this.tilesets=null},setRenderer:function(renderer){this.renderer=renderer},initArray:function(w,h){this.layerData=[];for(var x=0;x<w;x++){this.layerData[x]=[];for(var y=0;y<h;y++){this.layerData[x][y]=null}}},getTileId:function(x,y){var tile=this.getTile(x,y);return tile?tile.tileId:null},getTile:function(x,y){return this.layerData[~~(x/this.tilewidth)][~~(y/this.tileheight)]},setTile:function(x,y,tileId){this.layerData[x][y]=new me.Tile(x,y,this.tilewidth,this.tileheight,tileId)},clearTile:function(x,y){this.layerData[x][y]=null;if(this.visible&&this.preRender){this.layerSurface.clearRect(x*this.tilewidth,y*this.tileheight,this.tilewidth,this.tileheight)}},getOpacity:function(){return this.opacity},setOpacity:function(alpha){if(typeof(alpha)==="number"){this.opacity=alpha.clamp(0,1);if(this.preRender){this.layerSurface.globalAlpha=this.opacity}}},checkCollision:function(obj,pv){var x=(pv.x<0)?~~(obj.left+pv.x):Math.ceil(obj.right-1+pv.x);var y=(pv.y<0)?~~(obj.top+pv.y):Math.ceil(obj.bottom-1+pv.y);var res={x:0,xtile:undefined,xprop:{},y:0,ytile:undefined,yprop:{}};if(x<=0||x>=this.width){res.x=pv.x}else{if(pv.x!=0){res.xtile=this.getTile(x,Math.ceil(obj.bottom-1));if(res.xtile&&this.tileset.isTileCollidable(res.xtile.tileId)){res.x=pv.x;res.xprop=this.tileset.getTileProperties(res.xtile.tileId)}else{res.xtile=this.getTile(x,~~obj.top);if(res.xtile&&this.tileset.isTileCollidable(res.xtile.tileId)){res.x=pv.x;res.xprop=this.tileset.getTileProperties(res.xtile.tileId)}}}}res.ytile=this.getTile((pv.x<0)?~~obj.left:Math.ceil(obj.right-1),y);if(res.ytile&&this.tileset.isTileCollidable(res.ytile.tileId)){res.y=pv.y||1;res.yprop=this.tileset.getTileProperties(res.ytile.tileId)}else{res.ytile=this.getTile((pv.x<0)?Math.ceil(obj.right-1):~~obj.left,y);if(res.ytile&&this.tileset.isTileCollidable(res.ytile.tileId)){res.y=pv.y||1;res.yprop=this.tileset.getTileProperties(res.ytile.tileId)}}return res},update:function(){return false},draw:function(context,rect){var vpos=me.game.viewport.pos;if(this.preRender){var width=Math.min(rect.width,this.width);var height=Math.min(rect.height,this.height);context.drawImage(this.layerCanvas,vpos.x+rect.pos.x,vpos.y+rect.pos.y,width,height,vpos.x+rect.pos.x,vpos.y+rect.pos.y,width,height)}else{var _alpha=context.globalAlpha;context.globalAlpha=this.opacity;this.renderer.drawTileLayer(context,this,vpos,rect);context.globalAlpha=_alpha}}})})(window);(function($){me.TMXTileMap=me.Renderable.extend({init:function(levelId){this.levelId=levelId;this.z=0;this.name=null;this.cols=0;this.rows=0;this.tilewidth=0;this.tileheight=0;this.tilesets=null;this.mapLayers=[];this.objectGroups=[];this.initialized=false;this.version="";this.orientation="";this.tilesets=null;this.parent(new me.Vector2d(),0,0)},reset:function(){if(this.initialized===true){for(var i=this.mapLayers.length;i--;){this.mapLayers[i].reset();this.mapLayers[i]=null}for(var i=this.objectGroups.length;i--;){this.objectGroups[i].reset();this.objectGroups[i]=null}this.tilesets=null;this.mapLayers.length=0;this.objectGroups.length=0;this.pos.set(0,0);this.initialized=false}},getObjectGroupByName:function(name){var objectGroup=null;name=name.trim().toLowerCase();for(var i=this.objectGroups.length;i--;){if(this.objectGroups[i].name.toLowerCase().contains(name)){objectGroup=this.objectGroups[i];break}}return objectGroup},getObjectGroups:function(){return this.objectGroups},getLayers:function(){return this.mapLayers},getLayerByName:function(name){var layer=null;name=name.trim().toLowerCase();for(var i=this.mapLayers.length;i--;){if(this.mapLayers[i].name.toLowerCase().contains(name)){layer=this.mapLayers[i];break}}if((name.toLowerCase().contains(me.COLLISION_LAYER))&&(layer==null)){layer=new me.CollisionTiledLayer(me.game.currentLevel.width,me.game.currentLevel.height)}return layer},clearTile:function(x,y){for(var i=this.mapLayers.length;i--;){if(this.mapLayers[i] instanceof me.TMXLayer){this.mapLayers[i].clearTile(x,y)}}}})})(window);(function(window){me.TMXMapReader=Object.extend({XMLReader:null,JSONReader:null,TMXParser:null,readMap:function(map){if(map.initialized){return}if(me.loader.getTMXFormat(map.levelId)==="xml"){if(this.XMLReader===null){this.XMLReader=new XMLMapReader()}this.TMXParser=this.XMLReader.TMXParser;this.XMLReader.readXMLMap(map,me.loader.getTMX(map.levelId))}else{if(this.JSONReader===null){this.JSONReader=new JSONMapReader()}this.JSONReader.readJSONMap(map,me.loader.getTMX(map.levelId))}if((map.width<me.game.viewport.width)||(map.height<me.game.viewport.height)){var shiftX=~~((me.game.viewport.width-map.width)/2);var shiftY=~~((me.game.viewport.height-map.height)/2);map.pos.add({x:shiftX>0?shiftX:0,y:shiftY>0?shiftY:0})}map.initialized=true},getNewDefaultRenderer:function(obj){switch(obj.orientation){case"orthogonal":return new me.TMXOrthogonalRenderer(obj.cols,obj.rows,obj.tilewidth,obj.tileheight);break;case"isometric":return new me.TMXIsometricRenderer(obj.cols,obj.rows,obj.tilewidth,obj.tileheight);break;default:throw"melonJS: "+obj.orientation+" type TMX Tile Map not supported!"}},setLayerData:function(layer,data,encoding,compression){layer.initArray(layer.cols,layer.rows);switch(encoding){case null:var data=data.getElementsByTagName(me.TMX_TAG_TILE);break;case"json":break;case me.TMX_TAG_CSV:case me.TMX_TAG_ATTR_BASE64:var nodeValue="";for(var i=0,len=data.childNodes.length;i<len;i++){nodeValue+=data.childNodes[i].nodeValue}if(encoding==me.TMX_TAG_CSV){var data=me.utils.decodeCSV(nodeValue,layer.cols)}else{var data=me.utils.decodeBase64AsArray(nodeValue,4);if(compression!==null){data=me.utils.decompress(data,compression)}}nodeValue=null;break;default:throw"melonJS: TMX Tile Map "+encoding+" encoding not supported!";break}var idx=0;for(var y=0;y<layer.rows;y++){for(var x=0;x<layer.cols;x++){var gid=(encoding==null)?this.TMXParser.getIntAttribute(data[idx++],me.TMX_TAG_GID):data[idx++];if(gid!==0){var tmxTile=new me.Tile(x,y,layer.tilewidth,layer.tileheight,gid);layer.layerData[x][y]=tmxTile;if(!layer.tileset.contains(tmxTile.tileId)){layer.tileset=layer.tilesets.getTilesetByGid(tmxTile.tileId)}if(layer.visible&&layer.preRender){layer.renderer.drawTile(layer.layerSurface,x,y,tmxTile,layer.tileset)}}}}}});function _TinyTMXParser(){var parserObj={tmxDoc:null,setData:function(data){this.tmxDoc=data},getFirstElementByTagName:function(name){return this.tmxDoc?this.tmxDoc.getElementsByTagName(name)[0]:null},getAllTagElements:function(){return this.tmxDoc?this.tmxDoc.getElementsByTagName("*"):null},getStringAttribute:function(elt,str,val){var ret=elt.getAttribute(str);return ret?ret.trim():val},getIntAttribute:function(elt,str,val){var ret=this.getStringAttribute(elt,str,val);return ret?parseInt(ret):val},getFloatAttribute:function(elt,str,val){var ret=this.getStringAttribute(elt,str,val);return ret?parseFloat(ret):val},getBooleanAttribute:function(elt,str,val){var ret=this.getStringAttribute(elt,str,val);return ret?(ret=="true"):val},free:function(){this.tmxDoc=null}};return parserObj}var XMLMapReader=me.TMXMapReader.extend({TMXParser:null,init:function(){if(!this.TMXParser){this.TMXParser=new _TinyTMXParser()}},readXMLMap:function(map,data){if(!data){throw"melonJS:"+map.levelId+" TMX map not found"}var zOrder=0;this.TMXParser.setData(data);var xmlElements=this.TMXParser.getAllTagElements();for(var i=0;i<xmlElements.length;i++){switch(xmlElements.item(i).nodeName){case me.TMX_TAG_MAP:var elements=xmlElements.item(i);map.version=this.TMXParser.getStringAttribute(elements,me.TMX_TAG_VERSION);map.orientation=this.TMXParser.getStringAttribute(elements,me.TMX_TAG_ORIENTATION);map.cols=this.TMXParser.getIntAttribute(elements,me.TMX_TAG_WIDTH);map.rows=this.TMXParser.getIntAttribute(elements,me.TMX_TAG_HEIGHT);map.tilewidth=this.TMXParser.getIntAttribute(elements,me.TMX_TAG_TILEWIDTH);map.tileheight=this.TMXParser.getIntAttribute(elements,me.TMX_TAG_TILEHEIGHT);map.width=map.cols*map.tilewidth;map.height=map.rows*map.tileheight;map.backgroundcolor=this.TMXParser.getStringAttribute(elements,me.TMX_BACKGROUND_COLOR);map.z=zOrder++;me.TMXUtils.applyTMXPropertiesFromXML(map,elements);map.background_color=map.backgroundcolor?map.backgroundcolor:map.background_color;if(map.background_color){map.mapLayers.push(new me.ColorLayer("background_color",map.background_color,zOrder++))}if(map.background_image){map.mapLayers.push(new me.ImageLayer("background_image",map.width,map.height,map.background_image,zOrder++))}if((me.game.renderer===null)||!me.game.renderer.canRender(map)){me.game.renderer=this.getNewDefaultRenderer(map)}break;case me.TMX_TAG_TILESET:if(!map.tilesets){map.tilesets=new me.TMXTilesetGroup()}map.tilesets.add(this.readTileset(xmlElements.item(i)));break;case me.TMX_TAG_IMAGE_LAYER:map.mapLayers.push(this.readImageLayer(map,xmlElements.item(i),zOrder++));break;case me.TMX_TAG_LAYER:map.mapLayers.push(this.readLayer(map,xmlElements.item(i),zOrder++));break;case me.TMX_TAG_OBJECTGROUP:map.objectGroups.push(this.readObjectGroup(map,xmlElements.item(i),zOrder++));break;default:break}}this.TMXParser.free()},readLayer:function(map,data,z){var layer=new me.TMXLayer(map.tilewidth,map.tileheight,map.orientation,map.tilesets,z);layer.initFromXML(data);var layerData=data.getElementsByTagName(me.TMX_TAG_DATA)[0];var encoding=this.TMXParser.getStringAttribute(layerData,me.TMX_TAG_ENCODING,null);var compression=this.TMXParser.getStringAttribute(layerData,me.TMX_TAG_COMPRESSION,null);if(encoding==""){encoding=null}if(compression==""){compression=null}if(!layer.isCollisionMap||me.debug.renderCollisionMap){if(!me.game.renderer.canRender(layer)){layer.setRenderer(me.mapReader.getNewDefaultRenderer(layer))}else{layer.setRenderer(me.game.renderer)}}this.setLayerData(layer,layerData,encoding,compression);layerData=null;return layer},readImageLayer:function(map,data,z){var iln=this.TMXParser.getStringAttribute(data,me.TMX_TAG_NAME);var ilw=this.TMXParser.getIntAttribute(data,me.TMX_TAG_WIDTH);var ilh=this.TMXParser.getIntAttribute(data,me.TMX_TAG_HEIGHT);var ilsrc=data.getElementsByTagName(me.TMX_TAG_IMAGE)[0].getAttribute(me.TMX_TAG_SOURCE);var imageLayer=new me.ImageLayer(iln,ilw*map.tilewidth,ilh*map.tileheight,ilsrc,z);imageLayer.visible=(this.TMXParser.getIntAttribute(data,me.TMX_TAG_VISIBLE,1)==1);imageLayer.opacity=this.TMXParser.getFloatAttribute(data,me.TMX_TAG_OPACITY,1);me.TMXUtils.applyTMXPropertiesFromXML(imageLayer,data);if(typeof(imageLayer.ratio)==="number"){imageLayer.ratio=new me.Vector2d(parseFloat(imageLayer.ratio),parseFloat(imageLayer.ratio))}return imageLayer},readTileset:function(data){var tileset=new me.TMXTileset();tileset.initFromXML(data);return tileset},readObjectGroup:function(map,data,z){var name=this.TMXParser.getStringAttribute(data,me.TMX_TAG_NAME);var group=new me.TMXOBjectGroup();group.initFromXML(name,data,map.tilesets,z);return group}});var JSONMapReader=me.TMXMapReader.extend({readJSONMap:function(map,data){if(!data){throw"melonJS:"+map.levelId+" TMX map not found"}var zOrder=0;var self=this;map.version=data[me.TMX_TAG_VERSION];map.orientation=data[me.TMX_TAG_ORIENTATION];map.cols=parseInt(data[me.TMX_TAG_WIDTH]);map.rows=parseInt(data[me.TMX_TAG_HEIGHT]);map.tilewidth=parseInt(data[me.TMX_TAG_TILEWIDTH]);map.tileheight=parseInt(data[me.TMX_TAG_TILEHEIGHT]);map.width=map.cols*map.tilewidth;map.height=map.rows*map.tileheight;map.backgroundcolor=data[me.TMX_BACKGROUND_COLOR];map.z=zOrder++;me.TMXUtils.applyTMXPropertiesFromJSON(map,data);map.background_color=map.backgroundcolor?map.backgroundcolor:map.background_color;if(map.background_color){map.mapLayers.push(new me.ColorLayer("background_color",map.background_color,zOrder++))}if(map.background_image){map.mapLayers.push(new me.ImageLayer("background_image",map.width,map.height,map.background_image,zOrder++))}if((me.game.renderer===null)||!me.game.renderer.canRender(map)){me.game.renderer=this.getNewDefaultRenderer(map)}if(!map.tilesets){map.tilesets=new me.TMXTilesetGroup()}data.tilesets.forEach(function(tileset){map.tilesets.add(self.readTileset(tileset))});data.layers.forEach(function(layer){switch(layer.type){case me.TMX_TAG_IMAGE_LAYER:map.mapLayers.push(self.readImageLayer(map,layer,zOrder++));break;case me.TMX_TAG_TILE_LAYER:map.mapLayers.push(self.readLayer(map,layer,zOrder++));break;case me.TMX_TAG_OBJECTGROUP:map.objectGroups.push(self.readObjectGroup(map,layer,zOrder++));break;default:break}})},readLayer:function(map,data,z){var layer=new me.TMXLayer(map.tilewidth,map.tileheight,map.orientation,map.tilesets,z);layer.initFromJSON(data);if(!layer.isCollisionMap){if(!me.game.renderer.canRender(layer)){layer.setRenderer(me.mapReader.getNewDefaultRenderer(layer))}else{layer.setRenderer(me.game.renderer)}}this.setLayerData(layer,data[me.TMX_TAG_DATA],"json",null);return layer},readImageLayer:function(map,data,z){var iln=data[me.TMX_TAG_NAME];var ilw=parseInt(data[me.TMX_TAG_WIDTH]);var ilh=parseInt(data[me.TMX_TAG_HEIGHT]);var ilsrc=data[me.TMX_TAG_IMAGE];var imageLayer=new me.ImageLayer(iln,ilw*map.tilewidth,ilh*map.tileheight,ilsrc,z);imageLayer.visible=data[me.TMX_TAG_VISIBLE];imageLayer.opacity=parseFloat(data[me.TMX_TAG_OPACITY]);me.TMXUtils.applyTMXPropertiesFromJSON(imageLayer,data);if(typeof(imageLayer.ratio)==="number"){imageLayer.ratio=new me.Vector2d(parseFloat(imageLayer.ratio),parseFloat(imageLayer.ratio))}return imageLayer},readTileset:function(data){var tileset=new me.TMXTileset();tileset.initFromJSON(data);return tileset},readObjectGroup:function(map,data,z){var group=new me.TMXOBjectGroup();group.initFromJSON(data[me.TMX_TAG_NAME],data,map.tilesets,z);return group}})})(window);(function($){me.levelDirector=(function(){var obj={};var levels={};var levelIdx=[];var currentLevelIdx=0;obj.reset=function(){};obj.addLevel=function(level){throw"melonJS: no level loader defined"};obj.addTMXLevel=function(levelId,callback){if(levels[levelId]==null){levels[levelId]=new me.TMXTileMap(levelId);levels[levelId].name=levelId;levelIdx.push(levelId)}else{return false}if(callback){callback()}return true};obj.loadLevel=function(levelId){levelId=levelId.toString().toLowerCase();if(levels[levelId]===undefined){throw ("melonJS: level "+levelId+" not found")}if(levels[levelId] instanceof me.TMXTileMap){var wasRunning=me.state.isRunning();if(wasRunning){me.state.pause()}me.game.reset();me.utils.resetGUID(levelId);if(levels[obj.getCurrentLevelId()]){levels[obj.getCurrentLevelId()].reset()}me.mapReader.readMap(levels[levelId]);currentLevelIdx=levelIdx.indexOf(levelId);me.game.loadTMXLevel(levels[levelId]);if(wasRunning){me.state.resume.defer()}}else{throw"melonJS: no level loader defined"}return true};obj.getCurrentLevelId=function(){return levelIdx[currentLevelIdx]},obj.reloadLevel=function(){return obj.loadLevel(obj.getCurrentLevelId())},obj.nextLevel=function(){if(currentLevelIdx+1<levelIdx.length){return obj.loadLevel(levelIdx[currentLevelIdx+1])}else{return false}};obj.previousLevel=function(){if(currentLevelIdx-1>=0){return obj.loadLevel(levelIdx[currentLevelIdx-1])}else{return false}};obj.levelCount=function(){return levelIdx.length};return obj})()})(window);(function(){me.Tween=function(object){var _object=object,_valuesStart={},_valuesDelta={},_valuesEnd={},_duration=1000,_delayTime=0,_startTime=null,_pauseTime=0,_easingFunction=me.Tween.Easing.Linear.EaseNone,_chainedTween=null,_onUpdateCallback=null,_onCompleteCallback=null;this.alwaysUpdate=true;this.to=function(properties,duration){if(duration!==undefined){_duration=duration}for(var property in properties){if(_object[property]===null){continue}_valuesEnd[property]=properties[property]}return this};this.start=function(){me.game.add(this,999);_startTime=me.timer.getTime()+_delayTime;_pauseTime=0;for(var property in _valuesEnd){if(_object[property]===null){continue}_valuesStart[property]=_object[property];_valuesDelta[property]=_valuesEnd[property]-_object[property]}return this};this.stop=function(){me.game.remove(this,true);return this};this.delay=function(amount){_delayTime=amount;return this};me.event.subscribe(me.event.STATE_PAUSE,function onPause(){if(_startTime){_pauseTime=me.timer.getTime()}});me.event.subscribe(me.event.STATE_RESUME,function onResume(){if(_startTime&&_pauseTime){_startTime+=me.timer.getTime()-_pauseTime}});this.easing=function(easing){_easingFunction=easing;return this};this.chain=function(chainedTween){_chainedTween=chainedTween;return this};this.onUpdate=function(onUpdateCallback){_onUpdateCallback=onUpdateCallback;return this};this.onComplete=function(onCompleteCallback){_onCompleteCallback=onCompleteCallback;return this};this.update=function(){var property,elapsed,value;var time=me.timer.getTime();if(time<_startTime){return true}if((elapsed=(time-_startTime)/_duration)>=1){elapsed=1}value=_easingFunction(elapsed);for(property in _valuesDelta){_object[property]=_valuesStart[property]+_valuesDelta[property]*value}if(_onUpdateCallback!==null){_onUpdateCallback.call(_object,value)}if(elapsed===1){me.game.remove(this,true);if(_onCompleteCallback!==null){_onCompleteCallback.call(_object)}if(_chainedTween!==null){_chainedTween.start()}return false}return true}};me.Tween.Easing={Linear:{},Quadratic:{},Cubic:{},Quartic:{},Quintic:{},Sinusoidal:{},Exponential:{},Circular:{},Elastic:{},Back:{},Bounce:{}};me.Tween.Easing.Linear.EaseNone=function(k){return k};me.Tween.Easing.Quadratic.EaseIn=function(k){return k*k};me.Tween.Easing.Quadratic.EaseOut=function(k){return k*(2-k)};me.Tween.Easing.Quadratic.EaseInOut=function(k){if((k*=2)<1){return 0.5*k*k}return -0.5*(--k*(k-2)-1)};me.Tween.Easing.Cubic.EaseIn=function(k){return k*k*k};me.Tween.Easing.Cubic.EaseOut=function(k){return --k*k*k+1};me.Tween.Easing.Cubic.EaseInOut=function(k){if((k*=2)<1){return 0.5*k*k*k}return 0.5*((k-=2)*k*k+2)};me.Tween.Easing.Quartic.EaseIn=function(k){return k*k*k*k};me.Tween.Easing.Quartic.EaseOut=function(k){return 1-(--k*k*k*k)};me.Tween.Easing.Quartic.EaseInOut=function(k){if((k*=2)<1){return 0.5*k*k*k*k}return -0.5*((k-=2)*k*k*k-2)};me.Tween.Easing.Quintic.EaseIn=function(k){return k*k*k*k*k};me.Tween.Easing.Quintic.EaseOut=function(k){return --k*k*k*k*k+1};me.Tween.Easing.Quintic.EaseInOut=function(k){if((k*=2)<1){return 0.5*k*k*k*k*k}return 0.5*((k-=2)*k*k*k*k+2)};me.Tween.Easing.Sinusoidal.EaseIn=function(k){return 1-Math.cos(k*Math.PI/2)};me.Tween.Easing.Sinusoidal.EaseOut=function(k){return Math.sin(k*Math.PI/2)};me.Tween.Easing.Sinusoidal.EaseInOut=function(k){return 0.5*(1-Math.cos(Math.PI*k))};me.Tween.Easing.Exponential.EaseIn=function(k){return k===0?0:Math.pow(1024,k-1)};me.Tween.Easing.Exponential.EaseOut=function(k){return k===1?1:1-Math.pow(2,-10*k)};me.Tween.Easing.Exponential.EaseInOut=function(k){if(k===0){return 0}if(k===1){return 1}if((k*=2)<1){return 0.5*Math.pow(1024,k-1)}return 0.5*(-Math.pow(2,-10*(k-1))+2)};me.Tween.Easing.Circular.EaseIn=function(k){return 1-Math.sqrt(1-k*k)};me.Tween.Easing.Circular.EaseOut=function(k){return Math.sqrt(1-(--k*k))};me.Tween.Easing.Circular.EaseInOut=function(k){if((k*=2)<1){return -0.5*(Math.sqrt(1-k*k)-1)}return 0.5*(Math.sqrt(1-(k-=2)*k)+1)};me.Tween.Easing.Elastic.EaseIn=function(k){var s,a=0.1,p=0.4;if(k===0){return 0}if(k===1){return 1}if(!a||a<1){a=1;s=p/4}else{s=p*Math.asin(1/a)/(2*Math.PI)}return -(a*Math.pow(2,10*(k-=1))*Math.sin((k-s)*(2*Math.PI)/p))};me.Tween.Easing.Elastic.EaseOut=function(k){var s,a=0.1,p=0.4;if(k===0){return 0}if(k===1){return 1}if(!a||a<1){a=1;s=p/4}else{s=p*Math.asin(1/a)/(2*Math.PI)}return(a*Math.pow(2,-10*k)*Math.sin((k-s)*(2*Math.PI)/p)+1)};me.Tween.Easing.Elastic.EaseInOut=function(k){var s,a=0.1,p=0.4;if(k===0){return 0}if(k===1){return 1}if(!a||a<1){a=1;s=p/4}else{s=p*Math.asin(1/a)/(2*Math.PI)}if((k*=2)<1){return -0.5*(a*Math.pow(2,10*(k-=1))*Math.sin((k-s)*(2*Math.PI)/p))}return a*Math.pow(2,-10*(k-=1))*Math.sin((k-s)*(2*Math.PI)/p)*0.5+1};me.Tween.Easing.Back.EaseIn=function(k){var s=1.70158;return k*k*((s+1)*k-s)};me.Tween.Easing.Back.EaseOut=function(k){var s=1.70158;return --k*k*((s+1)*k+s)+1};me.Tween.Easing.Back.EaseInOut=function(k){var s=1.70158*1.525;if((k*=2)<1){return 0.5*(k*k*((s+1)*k-s))}return 0.5*((k-=2)*k*((s+1)*k+s)+2)};me.Tween.Easing.Bounce.EaseIn=function(k){return 1-me.Tween.Easing.Bounce.EaseOut(1-k)};me.Tween.Easing.Bounce.EaseOut=function(k){if(k<(1/2.75)){return 7.5625*k*k}else{if(k<(2/2.75)){return 7.5625*(k-=(1.5/2.75))*k+0.75}else{if(k<(2.5/2.75)){return 7.5625*(k-=(2.25/2.75))*k+0.9375}else{return 7.5625*(k-=(2.625/2.75))*k+0.984375}}}};me.Tween.Easing.Bounce.EaseInOut=function(k){if(k<0.5){return me.Tween.Easing.Bounce.EaseIn(k*2)*0.5}return me.Tween.Easing.Bounce.EaseOut(k*2-1)*0.5+0.5}})();(function(){me.event=(function(){var obj={};var cache={};obj.STATE_PAUSE="me.state.onPause";obj.STATE_RESUME="me.state.onResume";obj.GAME_INIT="me.game.onInit";obj.LEVEL_LOADED="me.game.onLevelLoaded";obj.LOADER_COMPLETE="me.loader.onload";obj.LOADER_PROGRESS="me.loader.onProgress";obj.KEYDOWN="me.input.keydown";obj.KEYUP="me.input.keyup";obj.WINDOW_ONRESIZE="window.onresize";obj.WINDOW_ONSCROLL="window.onscroll";obj.publish=function(channel,args){var subs=cache[channel],len=subs?subs.length:0;while(len--){subs[len].apply(window,args||[])}};obj.subscribe=function(channel,callback){if(!cache[channel]){cache[channel]=[]}cache[channel].push(callback);return[channel,callback]};obj.unsubscribe=function(handle,callback){var subs=cache[callback?handle:handle[0]],callback=callback||handle[1],len=subs?subs.length:0;while(len--){if(subs[len]===callback){subs.splice(len,1)}}};return obj})()})();(function(){me.plugin=(function(){var singleton={};singleton.Base=Object.extend({version:undefined,init:function(){}});singleton.patch=function(proto,name,fn){if(proto.prototype!==undefined){var proto=proto.prototype}if(typeof(proto[name])=="function"){var _parent=proto[name];proto[name]=(function(name,fn){return function(){var tmp=this.parent;this.parent=_parent;var ret=fn.apply(this,arguments);this.parent=tmp;return ret}})(name,fn)}else{console.error(name+" is not an existing function")}};singleton.register=function(plugin,name){if(me.plugin[name]){console.error("plugin "+name+" already registered")}if(plugin.prototype.version===undefined){throw"melonJS: Plugin version not defined !"}else{if(me.sys.checkVersion(plugin.prototype.version)>0){throw ("melonJS: Plugin version mismatch, expected: "+plugin.prototype.version+", got: "+me.version)}}var _args=[];if(arguments.length>2){_args=Array.prototype.slice.call(arguments,1)}_args[0]=plugin;me.plugin[name]=new (plugin.bind.apply(plugin,_args))();if(!(me.plugin[name] instanceof me.plugin.Base)){throw"melonJS: Plugin should extend the me.plugin.Base Class !"}};return singleton})()})();
